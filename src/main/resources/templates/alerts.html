<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì•Œë¦¼ ì„¼í„°</title>
    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <!-- Custrom CSS (Optional, keeping if needed for specific overrides) -->
    <link rel="stylesheet" th:href="@{/css/style.css}" />

    <style></style>
  </head>
  <body class="bg-light">
    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar -->
        <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse p-0">
          <div class="position-sticky">
            <div class="sidebar-logo">
              <img src="/css/logo.png" alt="SMHRD ìš”ì–‘ë³‘ì› ë¡œê³ " />
              <div class="sidebar-title">SMHRD ìš”ì–‘ë³‘ì›</div>
              <div class="sidebar-subtitle">ì•ˆì „ ê´€ì œì‹œìŠ¤í…œ</div>
            </div>
            <ul class="nav flex-column px-3">
              <li class="nav-item">
                <a
                  class="nav-link"
                  th:href="@{/dashboard}"
                  th:classappend="${requestURI.contains('/dashboard')} ? 'active'"
                >
                  <i class="bi bi-speedometer2 me-2"></i>ëŒ€ì‹œë³´ë“œ
                </a>
              </li>
              <li class="nav-item">
                <a
                  class="nav-link"
                  th:href="@{/patients}"
                  th:classappend="${requestURI.contains('/patients')} ? 'active'"
                >
                  <i class="bi bi-hospital me-2"></i>ì¹¨ìƒ ê´€ë¦¬
                </a>
              </li>
              <li class="nav-item">
                <a
                  class="nav-link"
                  th:href="@{/rooms}"
                  th:classappend="${requestURI.contains('/rooms')} ? 'active'"
                >
                  <i class="bi bi-camera-video me-2"></i>ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§
                </a>
              </li>
              <li class="nav-item">
                <a
                  class="nav-link"
                  th:href="@{alerts}"
                  th:classappend="${requestURI.contains('/alerts')} ? 'active'"
                >
                  <i class="bi bi-bell me-2"></i>ì•Œë¦¼ ì„¼í„°
                </a>
              </li>
              <li class="nav-item"
                       th:if="${session.role == 'manager'}">
                       <a class="nav-link" th:href="@{/manager}"
                     th:classappend="${requestURI.contains('/manager')} ? 'active'">
                        <i class="bi bi-people-fill me-2"></i>ê´€ë¦¬ì
                  </a></li>
                  <li class="nav-item">
    <a class="nav-link text-danger" th:href="@{/logout}">
        <i class="bi bi-box-arrow-right me-2"></i>ë¡œê·¸ì•„ì›ƒ
    </a>
</li>
            </ul>
            <div class="mt-5 px-3">
              <span class="small text-muted" style="color: silver !important"
                >carepose 1.0.0</span
              >
            </div>
          </div>
        </nav>

        <!-- Main Content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
        
        
          <div class="page-header d-flex align-items-center">
            <div>
              <h1 class="page-title mb-1">ì•Œë¦¼ì„¼í„°</h1>
              <p class="text-muted mb-0">ìš•ì°½/ë‚™ìƒ ìœ„í—˜ ì•Œë¦¼</p>
            </div>
          </div>

       
          

          <!-- Alerts Section -->

          



         
    <script type="text/javascript">
    var today = new Date(); // ì „ì—­ ë³€ìˆ˜ë¡œ ì„¤ì •
    var selectedDate = null; // ì„ íƒëœ ë‚ ì§œ ì €ì¥

    function buildCalendar() {
      var calendarTableBody = document.querySelector("#calendar tbody");
      var calendarTitle = document.getElementById("calendarTitle");
      
      // ì œëª© ì„¤ì •
      calendarTitle.innerHTML = today.getFullYear() + "ë…„ " + (today.getMonth() + 1) + "ì›”";
      
      var firstDate = new Date(today.getFullYear(), today.getMonth(), 1);
      var lastDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
      
      // ê¸°ì¡´ ë‚ ì§œ ë°ì´í„°ë§Œ ì‚­ì œ
      calendarTableBody.innerHTML = "";

      var row = calendarTableBody.insertRow();
      var cnt = 0;

      // í˜„ì¬ ì‹¤ì œ ë‚ ì§œ (ì˜¤ëŠ˜)
      var realToday = new Date();

      // 1. ì‹œì‘ ìš”ì¼ê¹Œì§€ ë¹ˆ ì¹¸ ì±„ìš°ê¸°
      for (var i = 0; i < firstDate.getDay(); i++) {
        row.insertCell();
        cnt++;
      }

      // 2. ë‚ ì§œ ì±„ìš°ê¸°
      for (var i = 1; i <= lastDate.getDate(); i++) {
        var cell = row.insertCell();
        cell.innerHTML = i;
        cell.style.textAlign = "center";
        cell.style.cursor = "pointer";
        
        // ì˜¤ëŠ˜ ë‚ ì§œì¸ì§€ ì²´í¬
        var isToday = (realToday.getFullYear() === today.getFullYear() && 
                       realToday.getMonth() === today.getMonth() && 
                       realToday.getDate() === i);
        
        // ì˜¤ëŠ˜ ë‚ ì§œì— active í´ë˜ìŠ¤ ì¶”ê°€
        if (isToday) {
          cell.classList.add('active');
          cell.style.backgroundColor = "#8ac4eb";
          cell.style.color = "#ffffff";
          cell.style.fontWeight = "bold";
          cell.style.borderRadius = "6px";
        }
        
        // í´ë¦­ ì‹œ ë‚ ì§œ ì„ íƒ ì´ë²¤íŠ¸
        cell.onclick = (function(n) {
          return function() {
            var year = today.getFullYear();
            var month = ("0" + (today.getMonth() + 1)).slice(-2);
            var day = ("0" + n).slice(-2);
            var selectedYMD = year + "-" + month + "-" + day;
            
            // ì´ì „ ì„ íƒ í•´ì œ
            var allCells = document.querySelectorAll("#calendar tbody td");
            allCells.forEach(function(td) {
              if (!td.classList.contains('active') || td.innerHTML != realToday.getDate() || 
                  today.getFullYear() !== realToday.getFullYear() || 
                  today.getMonth() !== realToday.getMonth()) {
                td.style.backgroundColor = "";
                td.style.color = "";
                td.style.fontWeight = "";
                td.style.borderRadius = "";
              }
            });
            
            // ìƒˆë¡œìš´ ì„ íƒ í‘œì‹œ
            this.style.backgroundColor = "#ebaca4";
            this.style.color = "#ffffff";
            this.style.fontWeight = "bold";
            this.style.borderRadius = "6px";
            
            // ì˜¤ëŠ˜ ë‚ ì§œëŠ” íŒŒë€ìƒ‰ ìœ ì§€
            var todayCells = document.querySelectorAll("#calendar tbody td.active");
            todayCells.forEach(function(td) {
              var cellDate = parseInt(td.innerHTML);
              if (cellDate === realToday.getDate() && 
                  today.getFullYear() === realToday.getFullYear() && 
                  today.getMonth() === realToday.getMonth()) {
                td.style.backgroundColor = "#8ac4eb";
                td.style.color = "#ffffff";
              }
            });
            
            // í•´ë‹¹ ë‚ ì§œì˜ ì´ë²¤íŠ¸ ë¡œë“œ
            selectedDate = selectedYMD;
            updateDateBadge(selectedYMD); // ë‚ ì§œ ë°°ì§€ ì—…ë°ì´íŠ¸
            loadFallEventsByDate(selectedYMD);
            
            // input ìš”ì†Œê°€ ìˆë‹¤ë©´ ê°’ ì…ë ¥
            var dateInput = document.getElementById("date") || opener.document.getElementById("date");
            if(dateInput) dateInput.value = selectedYMD;
          };
        })(i);

        // ìš”ì¼ë³„ ìƒ‰ìƒ (ì˜¤ëŠ˜ì´ ì•„ë‹ ë•Œë§Œ)
        if (!isToday) {
          if (cnt % 7 == 0) cell.style.color = "#F79DC2"; // ì¼ìš”ì¼
          if (cnt % 7 == 6) cell.style.color = "skyblue"; // í† ìš”ì¼
        }

        cnt++;

        // í† ìš”ì¼ì´ë©´ ë‹¤ìŒ ì¤„ ìƒì„± (ë§ˆì§€ë§‰ ë‚ ì´ ì•„ë‹ ë•Œë§Œ)
        if (cnt % 7 == 0 && i < lastDate.getDate()) {
          row = calendarTableBody.insertRow();
        }
      }

      // 3. ë§ˆì§€ë§‰ ì¤„ ë‚˜ë¨¸ì§€ ë¹ˆ ì¹¸ ì±„ìš°ê¸°
      while (cnt % 7 != 0) {
        row.insertCell();
        cnt++;
      }
    }

    // ì´ì „ë‹¬/ë‹¤ìŒë‹¬ í•¨ìˆ˜
    function prevCalendar() {
      today = new Date(today.getFullYear(), today.getMonth() - 1, 1);
      buildCalendar();
    }

    function nextCalendar() {
      today = new Date(today.getFullYear(), today.getMonth() + 1, 1);
      buildCalendar();
    }

    // ì´ˆê¸° ì‹¤í–‰
    window.onload = function() {
      buildCalendar();
    };
</script>
<body>
<div class="row my-4">
  <div class="col-md-2">
<div class="card shadow-sm" style="padding: 10px; text-align:center; color:rgb(214, 116, 116); "><h5>ë‚ ì§œì„ íƒ</h5></div></div>
    <div class="col-md-10">
    <div class="card shadow-sm">
      <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <button class="btn btn-sm btn-outline-secondary" onclick="prevCalendar()">â—€</button>
        <h5 class="mb-0" id="calendarTitle">yyyyë…„ mì›”</h5>
        <button class="btn btn-sm btn-outline-secondary" onclick="nextCalendar()">â–¶</button>
      </div>
      <div class="card-body p-2">
        <table id="calendar" class="calendar-table">
          <thead>
            <tr>
              <th class="sun">ì¼</th>
              <th>ì›”</th>
              <th>í™”</th>
              <th>ìˆ˜</th>
              <th>ëª©</th>
              <th>ê¸ˆ</th>
              <th class="sat">í† </th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

  <!-- Alerts Section -->
            <div class="row g-4">
               <div class="col-6">
                  <div class="card shadow-sm mb-4">
                     <div
                        class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                        <h5 class="mb-0 text-secondary">
                           ìµœê·¼ ì´ë²¤íŠ¸
                           <span id="todayBadge" class="badge bg-primary ms-2"></span>
                        </h5>
                     </div>
                     <div class="card-body p-0">
                        <div class="list-group list-group-flush" id="fallEventList">
                           <!-- ì—¬ê¸°ì— ë‚™ìƒ ì´ë²¤íŠ¸ê°€ ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
                           <div class="list-group-item text-center text-muted">
                              ë¡œë”© ì¤‘...
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
               <div class="col-6">
                  <div class="card shadow-sm mb-4">
                     <div
                        class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                        <h5 class="mb-0 text-secondary">ìì„¸ ë³€ê²½ ì•Œë¦¼</h5>
                        <a href="#" class="btn btn-sm btn-outline-primary">ğŸ””
                           ìƒˆë¡œìš´ ì•Œë¦¼ 0ê±´</a>
                     </div>
                     <div class="card-body p-0">
                        <div class="list-group list-group-flush">
                           <!-- Example Alert Items -->

                           <div
                              class="list-group-item list-group-item-danger d-flex justify-content-between align-items-center">
                              <span>14:30 &nbsp; <b>103í˜¸
                                    B</b> &nbsp; ì²´ìœ„ ë³€ê²½ í•„ìš” (2ì‹œê°„ ì´ˆê³¼)
                              </span>
                              <button class="btn btn-sm btn-danger">ì²˜ë¦¬ ì™„ë£Œ</button>
                           </div>
                           <div
                              class="list-group-item list-group-item-danger d-flex justify-content-between align-items-center">
                              <span>14:30 &nbsp; <b>103í˜¸
                                    B</b> &nbsp; ì²´ìœ„ ë³€ê²½ í•„ìš” (2ì‹œê°„ ì´ˆê³¼)
                              </span>
                              <button class="btn btn-sm btn-danger">ì²˜ë¦¬ ì™„ë£Œ</button>
                           </div>
                           <div
                              class="list-group-item list-group-item-warning d-flex justify-content-between align-items-center">
                              <span>14:15 &nbsp; <b>101í˜¸
                                    B</b> &nbsp; ìì„¸ ìœ ì§€ ì‹œê°„ ì£¼ì˜
                              </span>
                              <button class="btn btn-sm btn-warning">ì²˜ë¦¬ ì™„ë£Œ</button>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
               <script>  
               // ë‚ ì§œ ë°°ì§€ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
               function updateDateBadge(dateStr = null) {
                   const targetDate = dateStr ? new Date(dateStr) : new Date();
                   
                   const year = targetDate.getFullYear();
                   const month = String(targetDate.getMonth() + 1).padStart(2, '0');
                   const day = String(targetDate.getDate()).padStart(2, '0');

                   const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
                   const dayOfWeek = days[targetDate.getDay()];

                   const formattedDate = `${year}.${month}.${day} (${dayOfWeek})`;

                   document.getElementById("todayBadge").textContent = formattedDate;
               }
               
               document.addEventListener("DOMContentLoaded", function () {
                   updateDateBadge(); // ì´ˆê¸°ì—ëŠ” ì˜¤ëŠ˜ ë‚ ì§œ í‘œì‹œ
               });
               
               // ë‚™ìƒ ì´ë²¤íŠ¸ ëª©ë¡ ë¡œë“œ (ì „ì²´ ë˜ëŠ” ë‚ ì§œ í•„í„°)
               async function loadFallEvents(dateFilter = null) {
                 try {
                   let url = "/api/fall/recent?limit=50";
                   const response = await fetch(url);
                   let falls = await response.json();
                   
                   // ë‚ ì§œ í•„í„°ê°€ ìˆìœ¼ë©´ í•´ë‹¹ ë‚ ì§œë§Œ í•„í„°ë§
                   if (dateFilter) {
                     falls = falls.filter(fall => {
                       const fallDate = new Date(fall.fallAt);
                       const filterDate = new Date(dateFilter);
                       return fallDate.getFullYear() === filterDate.getFullYear() &&
                              fallDate.getMonth() === filterDate.getMonth() &&
                              fallDate.getDate() === filterDate.getDate();
                     });
                   }
                   
                   const listContainer = document.getElementById("fallEventList");
                   
                   if (falls.length === 0) {
                     const message = dateFilter ? 
                       `${dateFilter} ë‚ ì§œì˜ ë‚™ìƒ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.` : 
                       "ë‚™ìƒ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.";
                     listContainer.innerHTML = `
                       <div class="list-group-item text-center text-muted">
                         ${message}
                       </div>
                     `;
                     return;
                   }
                   
                   listContainer.innerHTML = falls.map(fall => {
                     const date = new Date(fall.fallAt);
                     const timeStr = date.toLocaleTimeString('ko-KR', { 
                       hour: '2-digit', 
                       minute: '2-digit' 
                     });
                     
                     const fallBodyText = fall.fallBody ? fall.fallBody : "ë¯¸ìƒ";
                     
                     // handled_atì´ ìˆìœ¼ë©´ í™•ì¸ ì™„ë£Œ ë²„íŠ¼, ì—†ìœ¼ë©´ ê¸°ë¡ í™•ì¸ ë²„íŠ¼
                     const isHandled = fall.handledAt !== null;
                     const buttonClass = isHandled ? "btn-success" : "btn-outline-primary";
                     const buttonText = isHandled ? "í™•ì¸ ì™„ë£Œ" : "ê¸°ë¡ í™•ì¸";
                     const buttonDisabled = isHandled ? "disabled" : "";
                     
                     return `
                       <div class="list-group-item d-flex justify-content-between align-items-center">
                         <span>${timeStr} &nbsp; <b>${fall.patientId}</b> &nbsp; ë‚™ìƒ ë°œìƒ: ${fallBodyText}</span>
                         <button class="btn btn-sm ${buttonClass}" 
                                 onclick="viewFallDetail(${fall.fallNum})" 
                                 ${buttonDisabled}
                                 id="fallBtn${fall.fallNum}">
                           ${buttonText}
                         </button>
                       </div>
                     `;
                   }).join('');
                   
                 } catch (error) {
                   console.error("ë‚™ìƒ ì´ë²¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨:", error);
                   document.getElementById("fallEventList").innerHTML = `
                     <div class="list-group-item text-center text-danger">
                       ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨
                     </div>
                   `;
                 }
               }
               
               // íŠ¹ì • ë‚ ì§œì˜ ì´ë²¤íŠ¸ë§Œ ë¡œë“œ
               function loadFallEventsByDate(dateStr) {
                 console.log("ğŸ“… ì„ íƒëœ ë‚ ì§œ:", dateStr);
                 loadFallEvents(dateStr);
               }
               
               // ê¸°ë¡ í™•ì¸ ë²„íŠ¼ í´ë¦­
               async function viewFallDetail(fallNum) {
                 const button = document.getElementById(`fallBtn${fallNum}`);
                 
                 // ì´ë¯¸ í™•ì¸ ì™„ë£Œëœ ê²½ìš°
                 if (button.disabled) {
                   return;
                 }
                 
                 try {
                   const response = await fetch(`/api/fall/handle/${fallNum}`, {
                     method: 'POST'
                   });
                   const result = await response.json();
                   
                   if (result.success) {
                     // ë²„íŠ¼ì„ ì´ˆë¡ìƒ‰ í™•ì¸ ì™„ë£Œë¡œ ë³€ê²½
                     button.className = "btn btn-sm btn-success";
                     button.textContent = "í™•ì¸ ì™„ë£Œ";
                     button.disabled = true;
                     console.log("âœ… ê¸°ë¡ í™•ì¸ ì™„ë£Œ:", fallNum);
                   } else {
                     alert("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                   }
                 } catch (error) {
                   console.error("ê¸°ë¡ í™•ì¸ ì‹¤íŒ¨:", error);
                   alert("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                 }
               }
               
               // í˜ì´ì§€ ë¡œë“œ ì‹œ ëª©ë¡ ë¡œë“œ
               loadFallEvents();
               
               // 10ì´ˆë§ˆë‹¤ ëª©ë¡ ì—…ë°ì´íŠ¸ (ì„ íƒëœ ë‚ ì§œê°€ ìˆìœ¼ë©´ ê·¸ ë‚ ì§œë¡œ)
               setInterval(function() {
                 if (selectedDate) {
                   loadFallEvents(selectedDate);
                 } else {
                   loadFallEvents();
                 }
               }, 10000);
               
</script>
  </body>
</html>
