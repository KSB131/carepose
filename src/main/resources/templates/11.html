<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ê´€ë¦¬ ì‹œìŠ¤í…œ ëŒ€ì‹œë³´ë“œ</title>
<!-- Bootstrap 5 CSS -->
<link
   href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
   rel="stylesheet" />
<link rel="stylesheet"
   href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
<!-- Custrom CSS (Optional, keeping if needed for specific overrides) -->
<link rel="stylesheet" th:href="@{/css/style.css}" />
</head>
<style>
/* ìŠ¤íƒ€ì¼ íƒœê·¸ ì•ˆì— ì¶”ê°€ */
#clock {
   font-family: "Courier New", Courier, monospace; /* ìˆ«ì í­ì„ ì¼ì •í•˜ê²Œ ìœ ì§€ */
   font-weight: bold;
   margin-left: 5px;
}
/* ë°•ìŠ¤ì™€ ë°•ìŠ¤ ê°„ê²© */
.sensor-widget {
   margin-bottom: -40px;
}

.sensor-card {
   background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
   color: white;
   border: none;
   transition: transform 0.2s;
   height: 80px;
}

.sensor-card * {
   line-height: 1;
}

.sensor-card .card-body {
   padding: 0.05rem 0.4rem; /* ìœ„ì•„ë˜ / ì¢Œìš° */
   height: 100%;
   display: flex;
   flex-direction: column;
   justify-content: center;
   align-items: center;
}

.sensor-title, .sensor-unit {
   margin: 0;
   padding: 0;
}

.sensor-card:hover {
   transform: translateY(-3px);
}

.sensor-value {
   font-size: 1.5rem;
   font-weight: bold;
}
</style>

<body class="bg-light">
   <div class="container-fluid">
      <div class="row">
         <!-- Sidebar -->
         <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse p-0">
            <div class="position-sticky pt-4 px-3">
               <div class="sidebar-logo">
                  <div class="sidebar-title">SMHRD ìš”ì–‘ë³‘ì›</div>
                  <div class="sidebar-subtitle">ì•ˆì „ ê´€ì œì‹œìŠ¤í…œ</div>
               </div>
               <ul class="nav flex-column">
                  <li class="nav-item"><a class="nav-link"
                     th:href="@{/dashboard}"
                     th:classappend="${requestURI.contains('/dashboard')} ? 'active'">
                        <i class="bi bi-speedometer2 me-2"></i>ëŒ€ì‹œë³´ë“œ
                  </a></li>
                  <li class="nav-item"><a class="nav-link"
                     th:href="@{/patients}"
                     th:classappend="${requestURI.contains('/patients')} ? 'active'">
                        <i class="bi bi-hospital me-2"></i>ì¹¨ìƒ ê´€ë¦¬
                  </a></li>
                  <li class="nav-item"><a class="nav-link" th:href="@{/rooms}"
                     th:classappend="${requestURI.contains('/rooms')} ? 'active'">
                        <i class="bi bi-camera-video me-2"></i>ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§
                  </a></li>
                  <li class="nav-item"><a class="nav-link"
                     th:classappend="${requestURI.contains('/alerts')} ? 'active'">
                        <i class="bi bi-bell me-2"></i>ì•Œë¦¼ ì„¼í„°
                  </a></li>
               </ul>
               <div class="mt-5 px-3">
                  <span class="small text-muted" style="color: silver !important">carepose
                     1.0.0</span>
               </div>
            </div>
         </nav>

         <!-- Main Content -->
         <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="page-header d-flex align-items-center">
               <div>
                  <h1 class="page-title mb-1">6ë³‘ë™</h1>
                  <p class="text-muted mb-0">í™˜ì ëª¨ë‹ˆí„°ë§ í˜„í™©</p>
               </div>
               <div class="container">
                  <!-- ì˜¨ìŠµë„ ë°•ìŠ¤ -->
                  <div class="sensor-widget">
                     <div class="d-flex gap-2 justify-content-end">
                        <!-- ì˜¨ë„ ë°•ìŠ¤ -->
                        <div style="width: 120px">
                           <div class="card sensor-card"
                              style="background: linear-gradient(135deg, #f2d383 0%,#ed966b 100%);">
                              <div class="card-body text-center">
                                 <div class="sensor-title">ì˜¨ë„</div>
                                 <div class="sensor-value" id="temperature">--</div>
                                 <span class="sensor-unit">Â°C</span>
                              </div>
                           </div>
                        </div>

                        <!-- ìŠµë„ ë°•ìŠ¤ -->
                        <div style="width: 120px">
                           <div class="card sensor-card"
                              style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                              <div class="card-body text-center">
                                 <div class="sensor-title">ìŠµë„</div>
                                 <div class="sensor-value" id="humidity">--</div>
                                 <span class="sensor-unit">%</span>
                              </div>
                           </div>
                        </div>
                     </div>
                  </div>

                  <div class="last-update">
                     <span class="status"></span> <span id="status"></span>
                  </div>
               </div>

               <div class="btn-toolbar mb-2 mb-md-0">
                  <div class="btn-group me-6">
                     <button type="button" class="btn btn-lg btn-secondary">
                        í˜„ì¬ ì‹œê°„ <span id="clock"> </span>
                     </button>
                  </div>
               </div>
            </div>

            <!-- Status Cards -->
            <div class="row g-4 mb-4">
               <div class="col-md-3">
                  <div class="status-card h-100">
                     <span class="dot bg-primary"></span>
                     <div class="h3 fw-bold my-2" th:text="${totalPatientCount}">0</div>
                     <div class="text-muted">ì „ì²´ í™˜ì</div>
                  </div>
               </div>
               <div class="col-md-3">
                  <div class="status-card h-100">
                     <span class="dot bg-success"></span>
                     <div class="h3 fw-bold my-2" th:text="${normalPatientCount}">0</div>
                     <div class="text-muted">ì •ìƒ</div>
                  </div>
               </div>
               <div class="col-md-3">
                  <div class="status-card h-100">
                     <span class="dot bg-warning"></span>
                     <div class="h3 fw-bold my-2" th:text="${cautionPatientCount}">0</div>
                     <div class="text-muted">ì£¼ì˜</div>
                  </div>
               </div>
               <div class="col-md-3">
                  <div class="status-card h-100">
                     <span class="dot bg-danger"></span>
                     <div class="h3 fw-bold my-2" th:text="${dangerPatientCount}">0</div>
                     <div class="text-muted">ìœ„í—˜</div>
                  </div>
               </div>
            </div>

            <!-- Alerts Section -->
            <div class="row g-4">
               <div class="col-6">
                  <div class="card shadow-sm mb-4">
                     <div
                        class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                        <h5 class="mb-0 text-secondary">
                           ìµœê·¼ ì´ë²¤íŠ¸
                           <span id="todayBadge" class="badge bg-primary ms-2"></span>
                        </h5>
                     </div>
                     <div class="card-body p-0">
                        <div class="list-group list-group-flush" id="fallEventList">
                           <!-- ì—¬ê¸°ì— ë‚™ìƒ ì´ë²¤íŠ¸ê°€ ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
                           <div class="list-group-item text-center text-muted">
                              ë¡œë”© ì¤‘...
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
               <div class="col-6">
                  <div class="card shadow-sm mb-4">
                     <div
                        class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                        <h5 class="mb-0 text-secondary">ìì„¸ ë³€ê²½ ì•Œë¦¼</h5>
                        <a href="#" class="btn btn-sm btn-outline-primary">ğŸ””
                           ìƒˆë¡œìš´ ì•Œë¦¼ 0ê±´</a>
                     </div>
                     <div class="card-body p-0">
                        <div class="list-group list-group-flush">
                           <!-- Example Alert Items -->

                           <div
                              class="list-group-item list-group-item-danger d-flex justify-content-between align-items-center">
                              <span>14:30 &nbsp; <b>103í˜¸
                                    B</b> &nbsp; ì²´ìœ„ ë³€ê²½ í•„ìš” (2ì‹œê°„ ì´ˆê³¼)
                              </span>
                              <button class="btn btn-sm btn-danger">ì²˜ë¦¬ ì™„ë£Œ</button>
                           </div>
                           <div
                              class="list-group-item list-group-item-danger d-flex justify-content-between align-items-center">
                              <span>14:30 &nbsp; <b>103í˜¸
                                    B</b> &nbsp; ì²´ìœ„ ë³€ê²½ í•„ìš” (2ì‹œê°„ ì´ˆê³¼)
                              </span>
                              <button class="btn btn-sm btn-danger">ì²˜ë¦¬ ì™„ë£Œ</button>
                           </div>
                           <div
                              class="list-group-item list-group-item-warning d-flex justify-content-between align-items-center">
                              <span>14:15 &nbsp; <b>101í˜¸
                                    B</b> &nbsp; ìì„¸ ìœ ì§€ ì‹œê°„ ì£¼ì˜
                              </span>
                              <button class="btn btn-sm btn-warning">ì²˜ë¦¬ ì™„ë£Œ</button>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>


<div class="modal fade" id="fallModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content border-danger border-3">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>ë‚™ìƒ ìœ„í—˜ ê°ì§€
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body text-center p-4">
        <h2 class="mb-4 text-danger fw-bold">
          <span id="fallRoomNumber" style="font-size: 2.5rem;"></span> í™˜ì ë‚™ìƒ ìœ„í—˜ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.
        </h2>
        <p class="text-muted mb-3" style="font-size: 1.1rem;">
          <i class="bi bi-clock"></i> <span id="fallTimestamp"></span>
        </p>
        
        <div class="alert alert-warning mb-4" role="alert">
          <i class="bi bi-hourglass-split"></i> 
          <span id="countdown">15</span>ì´ˆ í›„ ìë™ìœ¼ë¡œ ë‹«í™ë‹ˆë‹¤
        </div>

        <div class="mb-4" style="max-height: 600px; overflow: hidden;">
          <img id="fallImage" class="rounded w-100"
               style="object-fit: contain; max-height: 600px;" />
        </div>

        <button type="button" class="btn btn-success btn-sm w-100" data-bs-dismiss="modal">
          í™•ì¸ (ì¡°ì¹˜ ì™„ë£Œ)
        </button>
      </div>
    </div>
  </div>
</div>




               <!-- Bootstrap 5 JS Bundle -->
               <script
                  src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
<script>
    // ì„¼ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    function fetchSensorData() {
      fetch("/api/sensor")
        .then((response) => response.json())
        .then((data) => {
          document.getElementById("temperature").textContent =
            data.temperature.toFixed(1);
          document.getElementById("humidity").textContent =
            data.humidity.toFixed(1);

          const now = new Date();
        })
        .catch((error) => {
          console.error("Error:", error);
          /* document.getElementById('status').textContent = 'ë°ì´í„° ë¡œë”© ì‹¤íŒ¨'; */
        });
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¦‰ì‹œ ì‹¤í–‰
    fetchSensorData();

    // 2ì´ˆë§ˆë‹¤ ìë™ ì—…ë°ì´íŠ¸
    setInterval(fetchSensorData, 2000);

    function updateClock() {
      const now = new Date();
      const timeString = now.toLocaleTimeString("ko-KR", {
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        hour12: false, // 24ì‹œê°„ í˜•ì‹ì´ ê¹”ë”í•˜ë©´ false, ì˜¤ì „/ì˜¤í›„ê°€ í•„ìš”í•˜ë©´ true
      });
      document.getElementById("clock").textContent = timeString;
    }

    // 1ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
    setInterval(updateClock, 1000);
    updateClock(); // ì¦‰ì‹œ ì‹¤í–‰

   //ë‚ ì§œë±ƒì§€ ì¶”ê°€
   document.addEventListener("DOMContentLoaded", function () {
    const today = new Date();

    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');

    const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
    const dayOfWeek = days[today.getDay()];

    const formattedDate = `${year}.${month}.${day} (${dayOfWeek})`;

    document.getElementById("todayBadge").textContent = formattedDate;
});

    // ë‚™ìƒ ì´ë²¤íŠ¸ ëª©ë¡ ë¡œë“œ
    async function loadFallEvents() {
      try {
        console.log("ğŸ” ë‚™ìƒ ì´ë²¤íŠ¸ ë¡œë“œ ì‹œì‘...");
        // ìºì‹œ ë°©ì§€ë¥¼ ìœ„í•´ timestamp ì¶”ê°€ ë° no-cache í—¤ë” ì„¤ì •
        const timestamp = new Date().getTime();
        const response = await fetch(`/api/fall/recent?limit=10&_t=${timestamp}`, {
          method: 'GET',
          headers: {
            'Cache-Control': 'no-cache, no-store, must-revalidate',
            'Pragma': 'no-cache',
            'Expires': '0'
          }
        });
        console.log("ğŸ“¡ API ì‘ë‹µ ìƒíƒœ:", response.status);
        const falls = await response.json();
        console.log("ğŸ“Š ë°›ì€ ë°ì´í„°:", falls);
        console.log("ğŸ“Š ë°ì´í„° ê°œìˆ˜:", falls.length);
        
        const listContainer = document.getElementById("fallEventList");
        
        if (falls.length === 0) {
          console.log("âš ï¸ ë‚™ìƒ ê¸°ë¡ ì—†ìŒ");
          listContainer.innerHTML = `
            <div class="list-group-item text-center text-muted">
              ë‚™ìƒ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.
            </div>
          `;
          return;
        }
        
        listContainer.innerHTML = falls.map(fall => {
          const date = new Date(fall.fallAt);
          const timeStr = date.toLocaleTimeString('ko-KR', { 
            hour: '2-digit', 
            minute: '2-digit' 
          });
          
          const fallBodyText = fall.fallBody ? fall.fallBody : "ë¯¸ìƒ";
          
          // handled_atì´ ìˆìœ¼ë©´ í™•ì¸ ì™„ë£Œ ë²„íŠ¼, ì—†ìœ¼ë©´ ê¸°ë¡ í™•ì¸ ë²„íŠ¼
          const isHandled = fall.handledAt !== null;
          const buttonClass = isHandled ? "btn-success" : "btn-outline-primary";
          const buttonText = isHandled ? "í™•ì¸ ì™„ë£Œ" : "ê¸°ë¡ í™•ì¸";
          const buttonDisabled = isHandled ? "disabled" : "";
          
          return `
            <div class="list-group-item d-flex justify-content-between align-items-center">
              <span>${timeStr} &nbsp; <b>${fall.patientId}</b> &nbsp; ë‚™ìƒ ë°œìƒ: ${fallBodyText}</span>
              <button class="btn btn-sm ${buttonClass}" 
                      onclick="viewFallDetail(${fall.fallNum})" 
                      ${buttonDisabled}
                      id="fallBtn${fall.fallNum}">
                ${buttonText}
              </button>
            </div>
          `;
        }).join('');
        
        console.log("âœ… ë‚™ìƒ ì´ë²¤íŠ¸ ë Œë”ë§ ì™„ë£Œ");
        
      } catch (error) {
        console.error("âŒ ë‚™ìƒ ì´ë²¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨:", error);
        document.getElementById("fallEventList").innerHTML = `
          <div class="list-group-item text-center text-danger">
            ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨
          </div>
        `;
      }
    }
    
    // ê¸°ë¡ í™•ì¸ ë²„íŠ¼ í´ë¦­
    async function viewFallDetail(fallNum) {
      const button = document.getElementById(`fallBtn${fallNum}`);
      
      // ì´ë¯¸ í™•ì¸ ì™„ë£Œëœ ê²½ìš°
      if (button.disabled) {
        return;
      }
      
      try {
        const response = await fetch(`/api/fall/handle/${fallNum}`, {
          method: 'POST'
        });
        const result = await response.json();
        
        if (result.success) {
          // ë²„íŠ¼ì„ ì´ˆë¡ìƒ‰ í™•ì¸ ì™„ë£Œë¡œ ë³€ê²½
          button.className = "btn btn-sm btn-success";
          button.textContent = "í™•ì¸ ì™„ë£Œ";
          button.disabled = true;
          console.log("âœ… ê¸°ë¡ í™•ì¸ ì™„ë£Œ:", fallNum);
        } else {
          alert("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      } catch (error) {
        console.error("ê¸°ë¡ í™•ì¸ ì‹¤íŒ¨:", error);
        alert("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ëª©ë¡ ë¡œë“œ
    loadFallEvents();
    
    // 10ì´ˆë§ˆë‹¤ ëª©ë¡ ì—…ë°ì´íŠ¸
    setInterval(loadFallEvents, 10000);
    
    
    // ë‚™ìƒìœ„í—˜ ì•Œë¦¼
    let modalShown = false;
    let currentFallNum = null; // í˜„ì¬ ë‚™ìƒ ë²ˆí˜¸ ì €ì¥
    let handledFalls = []; // ì²˜ë¦¬ëœ ë‚™ìƒ ë²ˆí˜¸ë“¤
    let autoCloseTimer = null; // ìë™ ë‹«ê¸° íƒ€ì´ë¨¸
    let countdownInterval = null; // ì¹´ìš´íŠ¸ë‹¤ìš´ ì¸í„°ë²Œ
    let remainingSeconds = 15; // ë‚¨ì€ ì‹œê°„
    const modal = new bootstrap.Modal(document.getElementById("fallModal"));

    async function checkFallStatus() {
      try {
        const res = await fetch("http://localhost:8001/fall_status");
        const data = await res.json();
        
        console.log("ğŸ” Fetched data:", data);
        console.log("ğŸ” data.fall value:", data.fall, "type:", typeof data.fall);
        console.log("ğŸ” modalShown:", modalShown);

        if (data.fall === true) {
          console.log("âœ… Fall detected! Showing modal...");
          console.log("  Fall Num:", data.fall_num);
          console.log("ğŸ“ Room:", data.room);
          console.log("ğŸ–¼ï¸ Image:", data.image);
          console.log("â° Timestamp:", data.timestamp);
                    // ì´ë¯¸ ì²˜ë¦¬ëœ ë‚™ìƒì´ë©´ ë¬´ì‹œ
          if (handledFalls.includes(data.fall_num)) {
            console.log("âœ”ï¸ Already handled fall, skipping...");
            return;
          }
                    // ìƒˆë¡œìš´ ë‚™ìƒì´ê±°ë‚˜ ì•„ì§ ëª¨ë‹¬ì´ ì•ˆ ë–´ì„ ë•Œ
          if (!modalShown || currentFallNum !== data.fall_num) {
            // fall_num ì €ì¥
            currentFallNum = data.fall_num;
            
            // ì¹¨ìƒë²ˆí˜¸, ì‹œê°„, ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
            document.getElementById("fallRoomNumber").textContent = data.room || "Unknown";
            document.getElementById("fallTimestamp").textContent = data.timestamp || "";
            
            // ìºì‹œ ë°©ì§€ë¥¼ ìœ„í•´ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
            const imagePath = `/device/fall/${data.image}?t=${Date.now()}`;
            console.log("ğŸ”— Image path:", imagePath);
            document.getElementById("fallImage").src = imagePath;

            // ëª¨ë‹¬ì´ ì´ë¯¸ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ì•˜ë‹¤ê°€ ë‹¤ì‹œ ì—´ê¸°
            if (modalShown) {
              // ê¸°ì¡´ íƒ€ì´ë¨¸/ì¸í„°ë²Œ ì·¨ì†Œ
              if (autoCloseTimer) {
                clearTimeout(autoCloseTimer);
              }
              if (countdownInterval) {
                clearInterval(countdownInterval);
              }
              
              modal.hide();
              setTimeout(() => {
                modal.show();
                console.log("ğŸ”„ Modal updated with new fall!");
                
                // ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘
                startCountdown();
              }, 300);
            } else {
              modal.show();
              console.log("âœ… Modal shown!");
              
              // ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘
              startCountdown();
            }
            
            modalShown = true;
          } else {
            console.log("âš ï¸ Same fall, modal already shown, skipping...");
          }
        } else {
          modalShown = false;
          console.log("âŒ No fall detected (data.fall is false)");
        }
      } catch (e) {
        console.error("âŒ Error in checkFallStatus:", e);
      }
    }

    setInterval(checkFallStatus, 1500);
    
    // ì¹´ìš´íŠ¸ë‹¤ìš´ í•¨ìˆ˜
    function startCountdown() {
      remainingSeconds = 15;
      document.getElementById("countdown").textContent = remainingSeconds;
      
      // ê¸°ì¡´ ì¸í„°ë²Œ ì •ë¦¬
      if (countdownInterval) {
        clearInterval(countdownInterval);
      }
      
      // 1ì´ˆë§ˆë‹¤ ì¹´ìš´íŠ¸ë‹¤ìš´
      countdownInterval = setInterval(() => {
        remainingSeconds--;
        document.getElementById("countdown").textContent = remainingSeconds;
        
        if (remainingSeconds <= 0) {
          clearInterval(countdownInterval);
        }
      }, 1000);
      
      // 15ì´ˆ í›„ ìë™ ë‹«ê¸°
      autoCloseTimer = setTimeout(() => {
        modal.hide();
        console.log("â° Modal auto-closed after 15 seconds");
      }, 15000);
    }
    
    // í™•ì¸ ë²„íŠ¼ í´ë¦­ ì‹œ handled_at ì—…ë°ì´íŠ¸
    document.getElementById("fallModal").addEventListener("hidden.bs.modal", async function() {
      // íƒ€ì´ë¨¸ì™€ ì¸í„°ë²Œ ëª¨ë‘ ì·¨ì†Œ
      if (autoCloseTimer) {
        clearTimeout(autoCloseTimer);
        autoCloseTimer = null;
      }
      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
      
      if (currentFallNum) {
        try {
          const response = await fetch(`/api/fall/handle/${currentFallNum}`, {
            method: 'POST'
          });
          const result = await response.json();
          
          if (result.success) {
            console.log("âœ… ì¡°ì¹˜ ì™„ë£Œ ì²˜ë¦¬ë¨:", currentFallNum);
            // ì²˜ë¦¬ëœ ëª©ë¡ì— ì¶”ê°€
            handledFalls.push(currentFallNum);
          } else {
            console.error("âŒ ì¡°ì¹˜ ì™„ë£Œ ì²˜ë¦¬ ì‹¤íŒ¨:", result.message);
          }
        } catch (e) {
          console.error("âŒ API í˜¸ì¶œ ì‹¤íŒ¨:", e);
        }
        
        currentFallNum = null;
        modalShown = false;
      }
    });
  </script>
</html>
