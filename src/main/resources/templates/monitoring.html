<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</title>
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
   <link rel="stylesheet" th:href="@{/css/style.css}" />
   <style>
      :root {
         --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
         --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
         --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
         --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
         --card-shadow: 0 4px 20px rgba(100, 148, 237, 0.08);
         --gradient-main: linear-gradient(135deg, #fffaf7 0%, #fff0e5 100%);
      }
      
      .pose-icon-img {
    width: 32px;  /* ì•„ì´ì½˜ í¬ê¸°ì— ë§ì¶° ì¡°ì ˆ */
    height: 7d0px; /* ì•„ì´ì½˜ í¬ê¸°ì— ë§ì¶° ì¡°ì ˆ */
    object-fit: cover;
    border-radius: 4px; /* ì‚´ì§ ë‘¥ê¸€ê²Œ (ì„ íƒ) */
    vertical-align: middle;
    margin-right: 8px; /* í…ìŠ¤íŠ¸ì™€ì˜ ê°„ê²© */
}

      
      .room-center {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);

    font-size: 36px;
    font-weight: 900;
    color: #1f2937;
    
    background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
    padding: 8px 20px;
    border-radius: 14px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

/* ì¹´ë“œ ë°•ìŠ¤ì™€ ë°•ìŠ¤ ì‚¬ì´ì˜ ê°„ê²© */
#cameraGrid > .col {
    padding-bottom: 0px !important; /* ì›í•˜ëŠ” ê°„ê²©ë§Œí¼ ìˆ˜ì¹˜ ì¡°ì ˆ */
}
.camera-card {
    margin-top: 0 !important;
    margin-bottom: 22px !important;
}


   /* ì‹¤ì‹œê°„ ìº  ë¼ë²¨ ìŠ¤íƒ€ì¼ */
.camera-label {
    position: absolute;
    top: 2px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 20; /* ì´ë¯¸ì§€ë‚˜ ë‹¤ë¥¸ ë°°ì§€ë³´ë‹¤ ìœ„ì— ë°°ì¹˜ */
    
    background: #FAEF69;  /* ë°°ê²½ : ì—°í•œ ë…¸ë€ìƒ‰ */
    padding: 4px 16px;
    border-radius: 23px;
    font-size: 15px;
    font-weight: 800;
    color: #808080;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    border: 0px solid #000000;  /* í…Œë‘ë¦¬ : ê°•ì¡° ê²€ì€ìƒ‰ */
}

   /* ì˜¨ìŠµë„ ë°•ìŠ¤ */
   /* ë°•ìŠ¤ì™€ ë°•ìŠ¤ ê°„ê²© */
    .sensor-widget {
        margin-bottom: -40px;
    }
    
    .sensor-card {
       background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
       color: white;
       border: none;
       transition: transform 0.2s;
       height: 80px;
       border-radius: 15px; /* ì´ ë¶€ë¶„ì„ ì¶”ê°€í•˜ì—¬ ëª¨ì„œë¦¬ë¥¼ ë‘¥ê¸€ê²Œ ë§Œë“­ë‹ˆë‹¤ */
   }
    
    .sensor-card * {
       line-height: 1;
   }
    
    .sensor-card .card-body {
       padding: 0.05rem 0.4rem;  /* ìœ„ì•„ë˜ / ì¢Œìš° */
       height: 100%;
       
       display: flex;
       flex-direction: column;
       justify-content: center;
       align-items: center;
   }
   
   .sensor-title,
   .sensor-unit {
       margin: 0;
       padding: 0;
   }
    
    .sensor-card:hover {
        transform: translateY(-3px);
    }
    
    .sensor-value {
        font-size: 1.5rem;
        font-weight: bold;
    }
    

      
      /* ì¹´ë©”ë¼ ì¹´ë“œ */
      .camera-card {
         background: linear-gradient(145deg, #ffffff 0%, #f8fbff 100%);
         border-radius: 20px;
         overflow: hidden;
         border: 2px solid rgba(255, 255, 255, 0.8);
         box-shadow: var(--card-shadow);
         transition: all 0.3s ease;
         height: auto;
         padding-top: 35px;
         padding-bottom: 5px;
      }

      .camera-card:hover {
         transform: translateY(-4px);
         box-shadow: 0 12px 40px rgba(100, 148, 237, 0.15);
      }

      .camera-view {
         position: relative;
         background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
         display: flex;
		 height: 260px;
         overflow: hidden;
      }

      .camera-left {
         flex: 1;
         background: white;
		 position: relative;
         display: flex;
         align-items: center;
         justify-content: center;
         padding: 0px;
         border-right: 2px dashed rgba(100, 181, 246, 0.3);
		 height: 100%;
      }

      .camera-right {
         flex: 1;
         background: linear-gradient(135deg, #e0f2fe 0%, #d4f4e8 100%);
         display: flex;
         flex-direction: column;
         align-items: center;
         justify-content: center;
         padding: 0px;
      }

      .pose-arrow-center {
         position: absolute;
         top: 50%;
         left: 50%;
         transform: translate(-50%, -50%);
         width: 48px;
         height: 48px;
         background: white;
         border-radius: 50%;
         display: flex;
         align-items: center;
         justify-content: center;
         box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
         border: 3px solid #64b5f6;
         z-index: 10;
      }

      .status-badge {
         position: absolute;
         top: 12px;
         right: 12px;
         padding: 6px 14px;
         border-radius: 20px;
         font-size: 12px;
         font-weight: 700;
         color: white;
         z-index: 15;
         box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      }

      .status-normal {
         background: var(--success-gradient);
      }

      .status-warning {
         background: var(--warning-gradient);
      }

      .status-danger {
         background: var(--danger-gradient);
         animation: pulse 2s infinite;
      }

      @keyframes pulse {
         0%, 100% { opacity: 1; }
         50% { opacity: 0.7; }
      }

      /* í™˜ì ì •ë³´ ì˜ì—­ */
      .patient-info {
         padding: 1px;
         background: #F0F7FF;
         border-radius: 12px;
         text-align: center;
         margin-top: 3px;
      }
      
      .patient-data-wrapper {
		    display: flex;
		    gap: 10px; /* ë‘ ë°•ìŠ¤ ì‚¬ì´ì˜ ê°„ê²© */
		    align-items: stretch; /* ë‘ ë°•ìŠ¤ì˜ ë†’ì´ë¥¼ ë™ì¼í•˜ê²Œ */
		}
      
      .patient-bed, .pose-display {
		    flex: 1; /* ê°€ë¡œ ê³µê°„ì„ ì ˆë°˜ì”© ì°¨ì§€ */
		    background: #ffffff;
		    border-radius: 12px;
		    padding: 12px 240px; /* ë‚´ë¶€ ì—¬ë°± ì¤„ì„ */
		    text-align: center;
		    margin-top: 0 !important; /* ìœ„ì•„ë˜ ë§ˆì§„ ì œê±° */
		    display: flex;
		    flex-direction: column;
		    justify-content: center; /* ë‚´ìš© ì¤‘ì•™ ì •ë ¬ */
		    box-shadow: 0 2px 8px rgba(0,0,0,0.05); /* ì€ì€í•œ ê·¸ë¦¼ì */
		}

      .bed-badge {
         background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
         color: #374151;
         padding: 4px 12px;
         border-radius: 8px;
         font-size: 13px;
         font-weight: 600;
      }

      .patient-name {
         font-size: 20px;
         font-weight: 800;
         color: #1f2937;
         margin: 0;
      }


      .pose-current {
         display: flex;
         flex-direction: column;
         align-items: center;
         padding: 12px;
      }

      .pose-label {
         font-size: 11px;
         color: #6b7280;
         font-weight: 700;
         text-transform: uppercase;
         letter-spacing: 0.5px;
         margin-bottom: 6px;
      }

      .pose-value {
         font-size: 24px;
         font-weight: 900;
         color: #1f2937;
      }

      .pose-next .pose-value {
         color: #3b82f6;
      }

      .timer-display {
         background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
         border-radius: 12px;
         padding: 12px;
         text-align: center;
         margin-top: 12px;
      }

      .timer-label {
         display: block;
         font-size: 11px;
         color: #991b1b;
         font-weight: 600;
         margin-bottom: 4px;
         text-transform: uppercase;
      }

      .timer-value {
         font-size: 28px;
         font-weight: 900;
         color: #dc2626;
         font-family: 'Courier New', monospace;
         line-height: 0;
         margin: 0;
      }

      /* ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
      .patient-image {
      	 height: 100%;
      	 width: 100%;
         max-width: none;
         min-width: unset;
         max-height: none;
         min-height: unset;
         object-fit: fill;
      }

      .pose-icon {
         font-size: 48px;
         color: #3b82f6;
      }

      /* ë°˜ì‘í˜• */
      @media (max-width: 768px) {
         .camera-view {
            flex-direction: column;
         }
         
         .camera-left, .camera-right {
            border: none;
         }
         
         .pose-arrow-center {
            top: 50%;
         }
      }
      
   </style>
</head>
<body>
   <div class="container-fluid">
      <div class="row">
         <!-- ì‚¬ì´ë“œë°” -->
         <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse p-0">
                  <div class="position-sticky pt-4 px-3">
                     <div class="sidebar-logo">
                        <div class="sidebar-title">SMHRD ìš”ì–‘ë³‘ì›</div>
                        <div class="sidebar-subtitle">ì•ˆì „ ê´€ì œì‹œìŠ¤í…œ</div>
                     </div>
                     <ul class="nav flex-column">
                        <li class="nav-item">
                           <a class="nav-link" th:href="@{/dashboard}"
                              th:classappend="${requestURI.contains('/dashboard')} ? 'active'">
                              <i class="bi bi-speedometer2 me-2"></i>ëŒ€ì‹œë³´ë“œ
                           </a>
                        </li>
                        <li class="nav-item">
                           <a class="nav-link" th:href="@{/patients}"
                              th:classappend="${requestURI.contains('/patients')} ? 'active'">
                              <i class="bi bi-hospital me-2"></i>ì¹¨ìƒ ê´€ë¦¬ 
                           </a>
                        </li>
                        <li class="nav-item">
                           <a class="nav-link" th:href="@{/rooms}"
                              th:classappend="${requestURI.contains('/rooms')} ? 'active'">
                              <i class="bi bi-camera-video me-2"></i>ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§
                           </a>
                        </li>
                        <li class="nav-item">
                           <a class="nav-link"
                              th:classappend="${requestURI.contains('/alerts')} ? 'active'">
                              <i class="bi bi-bell me-2"></i>ì•Œë¦¼ ì„¼í„°
                           </a>
                        </li>
                        <li class="nav-item"><a class="nav-link" th:href="@{/manager}"
		                     th:classappend="${requestURI.contains('/manager')} ? 'active'">
		                        <i class="bi bi-bell me-2"></i>ê´€ë¦¬ì
		                  </a></li>
                     </ul>
                     <div class="mt-5 px-3">
                        <span class="small text-muted" style="color: silver !important;">carepose 1.0.0</span>
                     </div>
                  </div>
               </nav>

         <!-- ë©”ì¸ ì½˜í…ì¸  -->
         <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4" 
      th:with="targetRoom=${param.room != null ? param.room[0] : '---'}"> 

   <div class="page-header mb-6 d-flex align-items-center position-relative" style="min-height: 120px;">
      
      <div class="header-left">
         <h1 class="page-title mb-0">ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</h1>
      </div>
      
      <div class="room-center" th:text="${targetRoom} + í˜¸">
         601
      </div>
      

   
   <div class="d-flex align-items-center ms-auto gap-3">
      
      <div class="sensor-widget" style="margin-bottom: 0 !important;">
         <div class="d-flex gap-2"> 
            <div style="width: 120px;"> 
               <div class="card sensor-card" style="background: linear-gradient(135deg, #f2d383 0%, #ed966b 100%); margin-bottom: 0;">
                  <div class="card-body text-center">
                     <div class="sensor-title">ì˜¨ë„</div>
                     <div class="sensor-value" id="temperature">--</div>
                     <span class="sensor-unit">Â°C</span>
                  </div>
               </div>
            </div>
            
            <div style="width: 120px;">
               <div class="card sensor-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); margin-bottom: 0;">
                  <div class="card-body text-center">
                     <div class="sensor-title">ìŠµë„</div>
                     <div class="sensor-value" id="humidity">--</div>
                     <span class="sensor-unit">%</span>
                  </div>
               </div>
            </div>
         </div>
      </div>

   </div>
</div>

            <!-- ì¹´ë©”ë¼ ê·¸ë¦¬ë“œ -->
            <div id="cameraGrid" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 gx-4 gy-0">

   <div class="col" th:each="camera : ${cameras}"
        th:if="${camera.bedId != null and #strings.length(camera.bedId) >= 3 and #strings.substring(camera.bedId, 0, 3) == targetRoom}">
      <div class="card camera-card border-0">
         <div class="camera-view">
            <div class="camera-label">ì‹¤ì‹œê°„ ìº </div>
            <div class="status-badge status-normal" th:text="${camera.statusLabel}">ì •ìƒ</div>
            <img th:src="${camera.streamUrl}" style="width:100%; height:100%; object-fit:cover;">
         </div>
         <div class="patient-info text-center">
            <span class="bed-badge d-inline-block mb-1" th:text="${camera.bedId}"></span>
            <h6 class="patient-name mb-0" th:text="${camera.patientName}"></h6>
         </div>
      </div>
   </div>
         
            <!-- 2ï¸âƒ£ cameras ì—†ì„ ë•Œë§Œ patients -->
            <th:block th:if="${cameras == null or #lists.isEmpty(cameras)}">
               <div class="col" th:each="p : ${patients}"
                    th:if="${p.patientId != null and #strings.length(p.patientId) >= 3 and #strings.substring(p.patientId, 0, 3) == targetRoom}">
                  <div class="card camera-card border-0">
                     <button  type ="button"  class="camera-label" onclick="openCameraPopup()">ì‹¤ì‹œê°„ ìº </button>
         
                     <div class="camera-view">
                     <div class="status-badge status-normal">ì •ìƒ</div>
                  
                     <div class="camera-left"
                          th:data-folder="${#strings.substring(p.patientId, 0, 3)}"
                          th:data-sub="${p.patientId}"
                          th:data-pos="${p.position?.lastPosition}">
                  
                        <img class="patient-image dynamic-patient-img"
                             src="/images/bed_person.png"
                             alt="í˜„ì¬ ì²´ìœ„">
                     </div>
                  
                     <div class="pose-arrow-center">
                        <i class="bi bi-arrow-right text-primary fw-bold fs-4"></i>
                     </div>
                  
                     <div class="camera-right">
   <div class="pose-current" 
        th:with="cur=${p.position?.lastPosition}, 
                 nextPose=${cur == 'ì¢Œì¸¡ìœ„' ? 'ì•™ì™€ìœ„' : (cur == 'ì•™ì™€ìœ„' ? 'ìš°ì¸¡ìœ„' : (cur == 'ìš°ì¸¡ìœ„' ? 'ì¢Œì¸¡ìœ„' : 'í™•ì¸'))}">
      
      <span class="pose-label">ë³€ê²½ ì˜ˆì •</span>

      <img th:if="${nextPose != 'í™•ì¸'}" 
           th:src="@{'/images/' + ${nextPose} + '.png'}" 
           class="pose-icon-img" 
           th:alt="${nextPose}">
      
      <i th:if="${nextPose == 'í™•ì¸'}" class="bi bi-person-standing pose-icon"></i>

      <span class="pose-value" th:text="${nextPose}"></span>
   </div>
</div>
                  
                  </div>
                  
                  <div class="patient-info">
                   <div class="patient-data-wrapper">
                     <div class="patient-bed text-center">
					  <span class="bed-badge d-inline-block mb-1"
					        th:text="${p.patientId}"></span>
					  <h6 class="patient-name mb-0"
					      th:text="${p.name}"></h6>
					</div>
                  

                    </div>
                  
                     <div class="timer-display">
                        <span class="timer-label">ë‚¨ì€ ì‹œê°„</span>
                        <div class="timer-value timer-display"
                             th:data-patient-id="${p.patientId}">
                           00:00:00
                        </div>
                     </div>
                  </div>
                                    </div>
                                 </div>
                              </th:block>
                  
                        </div>
                     </div>
                  
                  </div>
         </main>
      </div>
   </div>

   <!-- Bootstrap Modal -->
   <div class="modal fade" id="alertModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
         <div class="modal-content border-danger border-3">
            <div class="modal-header bg-danger text-white">
               <h5 class="modal-title">
                  <i class="bi bi-exclamation-triangle-fill me-2"></i>ìì„¸ ë³€ê²½ ì•Œë¦¼
               </h5>
               <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center p-4">
               <p class="fs-5 mb-3">
                  <strong id="alertBed" class="text-danger"></strong> í™˜ìë¶„ ìì„¸ ë³€ê²½ ì‹œê°„ì…ë‹ˆë‹¤.
               </p>
               <div class="ratio ratio-16x9 mb-3">
                  <video id="guideVideo" muted loop class="rounded">
                     <source src="/videos/LtoS.mp4" type="video/mp4">
                  </video>
               </div>
               <button type="button" class="btn btn-success btn-lg w-100" data-bs-dismiss="modal">
                  <i class="bi bi-check-circle me-2"></i>í™•ì¸ (ì¡°ì¹˜ ì™„ë£Œ)
               </button>
            </div>
         </div>
      </div>
   </div>

   <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
   <script>
   let modalOpen = false;

   function setGrid(cols) {
      const grid = document.getElementById('cameraGrid');
      grid.className = 'row g-4';

      // bodyì—ì„œ ê¸°ì¡´ grid í´ë˜ìŠ¤ ì œê±°
      document.body.classList.remove('grid-4x2');

      if (cols === 2) {
         grid.classList.add('row-cols-1', 'row-cols-md-2');
      } else if (cols === 3) {
         grid.classList.add('row-cols-1', 'row-cols-md-2', 'row-cols-lg-3');
      } else if (cols === 4) {
         grid.classList.add('row-cols-1', 'row-cols-md-2', 'row-cols-lg-4');
         // 4x2 ëª¨ë“œì¼ ë•Œ ì»´íŒ©íŠ¸ ìŠ¤íƒ€ì¼ ì ìš©
         document.body.classList.add('grid-4x2');
      }

      // ëª¨ë“  ë²„íŠ¼ ë¹„í™œì„±í™”
      const buttons = document.querySelectorAll('.grid-control .btn');
      buttons.forEach(btn => {
         btn.classList.remove('btn-primary');
         btn.classList.add('btn-outline-secondary');
      });

      // í´ë¦­ëœ ë²„íŠ¼ë§Œ í™œì„±í™”
      event.target.closest('.btn').classList.remove('btn-outline-secondary');
      event.target.closest('.btn').classList.add('btn-primary');
   }

   // íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸ ì‹œë®¬ë ˆì´ì…˜

   function updateTimerDisplay(element, remaining) {
       const h = Math.floor(remaining / 3600);
       const m = Math.floor((remaining % 3600) / 60);
       const s = remaining % 60;

       element.textContent =
           `${String(h).padStart(2,'0')}:` +
           `${String(m).padStart(2,'0')}:` +
           `${String(s).padStart(2,'0')}`;
   }

   function syncTimers() {
	    fetch('/api/monitoringData')
	        .then(res => res.json())
	        .then(patients => {
	            patients.forEach(p => {

	                // 1ï¸âƒ£ íƒ€ì´ë¨¸ ì—˜ë¦¬ë¨¼íŠ¸ ì°¾ê¸°
	                const timerEl = document.querySelector(
	                    `.timer-value[data-patient-id="${p.patientId}"]`
	                );
	                if (!timerEl) return;

	                // 2ï¸âƒ£ DB ì‹œê°„ì´ ì—†ìœ¼ë©´ ìŠ¤í‚µ
	                if (!p.lastPositionTime) {
	                    timerEl.textContent = "00:00:00";
	                    return;
	                }

	                // 3ï¸âƒ£ ì‹œê°„ ê³„ì‚°
	                const startTime = new Date(p.lastPositionTime);
	                const now = new Date();

	                const totalSeconds = p.totalSeconds || 7200;
	                
	                let remaining =
	                    totalSeconds - Math.floor((now - startTime) / 1000);

	                if (remaining < 0) remaining = 0;

	                // 4ï¸âƒ£ í™”ë©´ ì¶œë ¥
	                const h = Math.floor(remaining / 3600);
	                const m = Math.floor((remaining % 3600) / 60);
	                const s = remaining % 60;

	                timerEl.textContent =
	                    `${String(h).padStart(2,'0')}:` +
	                    `${String(m).padStart(2,'0')}:` +
	                    `${String(s).padStart(2,'0')}`;

	                // 5ï¸âƒ£ 0ì´ˆ ì•Œë¦¼
	                if (remaining === 0 && timerEl.dataset.done !== "true") {

    timerEl.dataset.done = "true"; // ğŸ”’ ë‹¤ì‹œ ì‹¤í–‰ ë°©ì§€

    const card = timerEl.closest('.camera-card');
    const bedId = card.querySelector('.bed-badge').textContent;
    const patientName = card.querySelector('.patient-name').textContent;

    // âœ… 1. íŒì—… ë„ìš°ê¸°
    showAlert(`${bedId} (${patientName})`);

    // âœ… 2. ì„œë²„ì— ì‹œê°„ ê°±ì‹  ìš”ì²­
    fetch('/api/updatePositionTime', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams({
            bedId: bedId
        })
    })
    .then(res => res.text())
    .then(msg => console.log('â± DB ê°±ì‹ :', msg))
    .catch(err => console.error('DB ê°±ì‹  ì‹¤íŒ¨', err));
}
	            });
	        })
	        .catch(err => console.error('íƒ€ì´ë¨¸ ë™ê¸°í™” ì‹¤íŒ¨:', err));
   }

   // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¦‰ì‹œ ì‹¤í–‰
   syncTimers();

   // 2ì´ˆë§ˆë‹¤ ìë™ ë™ê¸°í™”
   setInterval(syncTimers, 1000);




function showAlert(bedInfo) {
  if (modalOpen) return;   // âœ… ì¤‘ë³µ ë°©ì§€
  modalOpen = true;

  document.getElementById('alertBed').textContent = bedInfo;
  const modalEl = document.getElementById('alertModal');
  const modal = new bootstrap.Modal(modalEl);

  modal.show();

  const video = document.getElementById('guideVideo');
  video.currentTime = 0;
  video.play().catch(() => {});

  // âœ… ëª¨ë‹¬ì´ ì™„ì „íˆ ë‹«íˆë©´ backdrop ì •ë¦¬
  modalEl.addEventListener('hidden.bs.modal', () => {
    modalOpen = false;
    video.pause();

    document
      .querySelectorAll('.modal-backdrop')
      .forEach(b => b.remove());

    document.body.classList.remove('modal-open');
    document.body.style.removeProperty('padding-right');
  }, { once: true });
}




   function loadLatestImages() {
       const cards = document.querySelectorAll('.camera-left');

       cards.forEach(card => {
          const folder = card.getAttribute('data-folder');
          const sub = card.getAttribute('data-sub');
          const pos = card.getAttribute('data-pos');
          const imgTag = card.querySelector('.dynamic-patient-img');

          let prefix = "default";
          if (pos === 'ì•™ì™€ìœ„') prefix = "face";
          else if (pos === 'ì¢Œì¸¡ìœ„') prefix = "left";
          else if (pos === 'ìš°ì¸¡ìœ„') prefix = "right";

          checkImageExists(imgTag, folder, sub, prefix, 30);
       });
    }

    function checkImageExists(imgTag, folder, sub, prefix, num) {
       if (num <= 0) return;

       const path = `/images/${folder}/${sub}/${prefix}${num}.jpg`;
       const img = new Image();

       img.onload = () => imgTag.src = path + "?v=" + Date.now();
       img.onerror = () => checkImageExists(imgTag, folder, sub, prefix, num - 1);
       img.src = path;
    }

    document.addEventListener("DOMContentLoaded", () => {
        loadLatestImages();
        setInterval(loadLatestImages, 3000); // âœ… 3ì´ˆë§ˆë‹¤ ì¬í™•ì¸
    });

    // ì„¼ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    function fetchSensorData() {
        fetch('/api/sensor')
            .then(response => response.json())
            .then(data => {
                document.getElementById('temperature').textContent = data.temperature.toFixed(1);
                document.getElementById('humidity').textContent = data.humidity.toFixed(1);

                const now = new Date();

            })
            .catch(error => {
                console.error('Error:', error);
                /* document.getElementById('status').textContent = 'ë°ì´í„° ë¡œë”© ì‹¤íŒ¨'; */
            });
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¦‰ì‹œ ì‹¤í–‰
    fetchSensorData();

    // 2ì´ˆë§ˆë‹¤ ìë™ ì—…ë°ì´íŠ¸
    setInterval(fetchSensorData, 2000);


    function openCameraPopup() {
        const width = 1024;
        const height = 768;
        const left = (screen.width - width) / 2;
        const top = (screen.height - height) / 2;

        const popup = window.open(
            '',
            'Pose_Classification_Stream',
            `width=${width},height=${height},left=${left},top=${top},resizable=yes`
        );

        popup.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <title>ì‹¤ì‹œê°„ ìì„¸ ë¶„ë¥˜ ëª¨ë‹ˆí„°ë§</title>
                <style>
                    * {
                        margin: 0;
                        padding: 0;
                        box-sizing: border-box;
                    }
                    body {
                        background: #1a1a1a;
                        display: flex;
                        flex-direction: column;
                        height: 100vh;
                        font-family: 'Segoe UI', Arial, sans-serif;
                    }
                    .header {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        padding: 20px 30px;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                    }
                    .header h1 {
                        font-size: 24px;
                        margin: 0 0 5px 0;
                    }
                    .header p {
                        font-size: 14px;
                        opacity: 0.9;
                        margin: 0;
                    }
                    .status-bar {
                        background: #2a2a2a;
                        padding: 10px 30px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        border-bottom: 2px solid #667eea;
                    }
                    .status-item {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        color: white;
                        font-size: 14px;
                    }
                    .status-dot {
                        width: 10px;
                        height: 10px;
                        background: #4CAF50;
                        border-radius: 50%;
                        animation: pulse 2s infinite;
                    }
                    @keyframes pulse {
                        0%, 100% { opacity: 1; transform: scale(1); }
                        50% { opacity: 0.5; transform: scale(1.1); }
                    }
                    .video-container {
                        flex: 1;
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        padding: 20px;
                        background: #000;
                    }
                    #videoStream {
                        max-width: 100%;
                        max-height: 100%;
                        border-radius: 10px;
                        box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
                    }
                    .info-panel {
                        background: #2a2a2a;
                        color: white;
                        padding: 15px 30px;
                        display: flex;
                        gap: 30px;
                        flex-wrap: wrap;
                    }
                    .info-item {
                        display: flex;
                        flex-direction: column;
                    }
                    .info-label {
                        font-size: 12px;
                        color: #999;
                        margin-bottom: 5px;
                    }
                    .info-value {
                        font-size: 18px;
                        font-weight: bold;
                        color: #4CAF50;
                    }
                    .controls {
                        background: #1a1a1a;
                        padding: 20px;
                        display: flex;
                        justify-content: center;
                        gap: 15px;
                    }
                    button {
                        padding: 12px 30px;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 15px;
                        font-weight: bold;
                        transition: all 0.3s;
                    }
                    .btn-close {
                        background: #f44336;
                        color: white;
                    }
                    .btn-close:hover {
                        background: #d32f2f;
                        transform: translateY(-2px);
                        box-shadow: 0 5px 15px rgba(244, 67, 54, 0.4);
                    }
</style>
</head>
<body>
  <div class="header">
    <h1>ğŸ¥ ì‹¤ì‹œê°„ ìì„¸ ë¶„ë¥˜ ëª¨ë‹ˆí„°ë§</h1>
    <p>YOLO11n-Pose + Custom Classification Model</p>
  </div>

  <div class="status-bar">
    <div class="status-item">
      <div class="status-dot"></div>
      <span>ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° í™œì„±í™”</span>
    </div>
    <div class="status-item">
      <span>ë¶„ë¥˜: supine / left / right</span>
    </div>
  </div>

  <div class="video-container">
    <img
      id="videoStream"
      src="http://192.168.219.208:8000/video_feed"
      alt="Loading..."
    />
  </div>

  <div class="info-panel">
    <div class="info-item">
      <div class="info-label">ëª¨ë¸ ìƒíƒœ</div>
      <div class="info-value">âœ“ ì •ìƒ</div>
    </div>
    <div class="info-item">
      <div class="info-label">FPS</div>
      <div class="info-value">~30</div>
    </div>
    <div class="info-item">
      <div class="info-label">í•´ìƒë„</div>
      <div class="info-value">640x480</div>
    </div>
  </div>

  <div class="controls">
    <button class="btn-close" onclick="window.close()">âŒ ì°½ ë‹«ê¸°</button>
  </div>

  <script>
                    const img = document.getElementById('videoStream');

                    img.onerror = function() {
                        alert('ì¹´ë©”ë¼ ì—°ê²° ì‹¤íŒ¨! FastAPI ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.\\n\\nì„œë²„ ì£¼ì†Œ: http://192.168.219.208:8000');
                    };

                    img.onload = function() {
                        console.log('âœ“ ìŠ¤íŠ¸ë¦¬ë° ì—°ê²° ì„±ê³µ');
                    };
                <\/script>
            </body>
            </html>
        `);
    }
   </script>
</body>
</html>