<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>실시간 모니터링</title>
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
   <style>
      :root {
         --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
         --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
         --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
         --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
         --card-shadow: 0 4px 20px rgba(100, 148, 237, 0.08);
         --gradient-main: linear-gradient(135deg, #fffaf7 0%, #fff0e5 100%);
      }

      body {
          margin: 0;
          min-height: 100vh;
          background: var(--gradient-main);
      }
      
      .room-center {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);

    font-size: 36px;
    font-weight: 900;
    color: #1f2937;
    
    background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
    padding: 8px 20px;
    border-radius: 14px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

   /* 실시간 캠 라벨 스타일 */
.camera-label {
    position: absolute;
    top: 12px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 20; /* 이미지나 다른 배지보다 위에 배치 */
    
    background: rgba(255, 255, 255, 0.85); /* 반투명 흰색 배경 */
    padding: 4px 16px;
    border-radius: 23px;
    font-size: 15px;
    font-weight: 800;
    color: #1f2937;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(0, 0, 0, 0.05);
}

   /* 온습도 박스 */
   /* 박스와 박스 간격 */
    .sensor-widget {
        margin-bottom: -40px;
    }
    
    .sensor-card {
       background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
       color: white;
       border: none;
       transition: transform 0.2s;
       height: 80px;
       border-radius: 15px; /* 이 부분을 추가하여 모서리를 둥글게 만듭니다 */
   }
    
    .sensor-card * {
       line-height: 1;
   }
    
    .sensor-card .card-body {
       padding: 0.05rem 0.4rem;  /* 위아래 / 좌우 */
       height: 100%;
       
       display: flex;
       flex-direction: column;
       justify-content: center;
       align-items: center;
   }
   
   .sensor-title,
   .sensor-unit {
       margin: 0;
       padding: 0;
   }
    
    .sensor-card:hover {
        transform: translateY(-3px);
    }
    
    .sensor-value {
        font-size: 1.5rem;
        font-weight: bold;
    }
    

      /* 사이드바 스타일 */
      .sidebar {
         background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
         min-height: 100vh;
         box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
      }

      .sidebar .nav-link {
         color: rgba(255, 255, 255, 0.75);
         padding: 14px 20px;
         border-radius: 12px;
         margin-bottom: 33px;
         transition: all 0.3s;
         font-weight: 600;
         display: flex;
         align-items: center;
      }

      .sidebar .nav-link:hover {
         background: rgba(255, 255, 255, 0.1);
         color: #fff;
         transform: translateX(4px);
      }

      .sidebar .nav-link.active {
         background: linear-gradient(135deg, rgba(100, 181, 246, 0.2) 0%, rgba(102, 126, 234, 0.2) 100%);
         color: white;
      }

      /* 페이지 헤더 */
      .page-header {
         background: linear-gradient(145deg, #ffffff 0%, #f8fbff 100%);
         border-radius: 20px;
         padding: 28px;
         margin-top: 16px;
         margin-bottom: 32px;
         box-shadow: 0 6px 25px rgba(100,148,237,.15);
      }

      .page-title {
         font-size: 40px;
         font-weight: 900;
         background: linear-gradient(135deg, #667eea, #764ba2);
         -webkit-background-clip: text;
         -webkit-text-fill-color: transparent;
      }

      /* 카메라 카드 */
      .camera-card {
         background: linear-gradient(145deg, #ffffff 0%, #f8fbff 100%);
         border-radius: 20px;
         overflow: hidden;
         border: 2px solid rgba(255, 255, 255, 0.8);
         box-shadow: var(--card-shadow);
         transition: all 0.3s ease;
         height: 100%;
      }

      .camera-card:hover {
         transform: translateY(-4px);
         box-shadow: 0 12px 40px rgba(100, 148, 237, 0.15);
      }

      .camera-view {
         position: relative;
         background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
         aspect-ratio: 16/9;
         display: flex;
      }

      .camera-left {
         flex: 1;
         background: white;
         display: flex;
         align-items: center;
         justify-content: center;
         padding: 20px;
         border-right: 2px dashed rgba(100, 181, 246, 0.3);
      }

      .camera-right {
         flex: 1;
         background: linear-gradient(135deg, #e0f2fe 0%, #d4f4e8 100%);
         display: flex;
         flex-direction: column;
         align-items: center;
         justify-content: center;
         padding: 20px;
      }

      .pose-arrow-center {
         position: absolute;
         top: 50%;
         left: 50%;
         transform: translate(-50%, -50%);
         width: 48px;
         height: 48px;
         background: white;
         border-radius: 50%;
         display: flex;
         align-items: center;
         justify-content: center;
         box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
         border: 3px solid #64b5f6;
         z-index: 10;
      }

      .status-badge {
         position: absolute;
         top: 12px;
         right: 12px;
         padding: 6px 14px;
         border-radius: 20px;
         font-size: 12px;
         font-weight: 700;
         color: white;
         z-index: 15;
         box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      }

      .status-normal {
         background: var(--success-gradient);
      }

      .status-warning {
         background: var(--warning-gradient);
      }

      .status-danger {
         background: var(--danger-gradient);
         animation: pulse 2s infinite;
      }

      @keyframes pulse {
         0%, 100% { opacity: 1; }
         50% { opacity: 0.7; }
      }

      /* 환자 정보 영역 */
      .patient-info {
         padding: 20px 24px;
         background: white;
      }

      .bed-badge {
         background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
         color: #374151;
         padding: 4px 12px;
         border-radius: 8px;
         font-size: 13px;
         font-weight: 600;
      }

      .patient-name {
         font-size: 20px;
         font-weight: 800;
         color: #1f2937;
         margin: 0;
      }

      .pose-display {
         background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
         border-radius: 12px;
         padding: 16px;
         margin-top: 12px;
      }

      .pose-current {
         display: flex;
         flex-direction: column;
         align-items: center;
         padding: 12px;
      }

      .pose-label {
         font-size: 11px;
         color: #6b7280;
         font-weight: 700;
         text-transform: uppercase;
         letter-spacing: 0.5px;
         margin-bottom: 6px;
      }

      .pose-value {
         font-size: 24px;
         font-weight: 900;
         color: #1f2937;
      }

      .pose-next .pose-value {
         color: #3b82f6;
      }

      .timer-display {
         background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
         border-radius: 12px;
         padding: 16px;
         text-align: center;
         margin-top: 12px;
      }

      .timer-label {
         display: block;
         font-size: 11px;
         color: #991b1b;
         font-weight: 600;
         margin-bottom: 4px;
         text-transform: uppercase;
      }

      .timer-value {
         font-size: 28px;
         font-weight: 900;
         color: #dc2626;
         font-family: 'Courier New', monospace;
      }

      /* 이미지 스타일 */
      .patient-image {
         max-width: 100%;
         max-height: 180px;
         object-fit: contain;
      }

      .pose-icon {
         font-size: 48px;
         color: #3b82f6;
      }

      /* 그리드 컨트롤 버튼 */
      .grid-control .btn {
         border-radius: 10px;
         font-weight: 600;
         padding: 8px 20px;
      }

      /* 반응형 */
      @media (max-width: 768px) {
         .camera-view {
            flex-direction: column;
         }
         
         .camera-left, .camera-right {
            border: none;
         }
         
         .pose-arrow-center {
            top: 50%;
         }
      }
   </style>
</head>
<body>
   <div class="container-fluid">
      <div class="row">
         <!-- 사이드바 -->
         <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse p-0">
            <div class="position-sticky pt-4 px-3">
               <div class="mb-4">
                  <h5 class="fw-bold text-white">SMHRD 요양병원<br>안전 관제시스템</h5>
               </div>
               <ul class="nav flex-column">
                  <li class="nav-item">
                     <a class="nav-link" th:href="@{/dashboard}"
                        th:classappend="${requestURI.contains('/dashboard')} ? 'active'">
                        <i class="bi bi-speedometer2 me-2"></i>대시보드
                     </a>
                  </li>
                  <li class="nav-item">
                     <a class="nav-link" th:href="@{/patients}"
                        th:classappend="${requestURI.contains('/patients')} ? 'active'">
                        <i class="bi bi-hospital me-2"></i>병실 현황
                     </a>
                  </li>
                  <li class="nav-item">
                     <a class="nav-link" th:href="@{/rooms}"
                        th:classappend="${requestURI.contains('/rooms')} ? 'active'">
                        <i class="bi bi-camera-video me-2"></i>실시간 모니터링
                     </a>
                  </li>
                  <li class="nav-item">
                     <a class="nav-link"
                        th:classappend="${requestURI.contains('/alerts')} ? 'active'">
                        <i class="bi bi-bell me-2"></i>알림 센터
                     </a>
                  </li>
               </ul>
               <div class="mt-5 px-3">
                  <span class="small text-muted" style="color: silver !important;">carepose 1.0.0</span>
               </div>
            </div>
         </nav>

         <!-- 메인 콘텐츠 -->
         <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4" 
      th:with="targetRoom=${param.room != null ? param.room[0] : '---'}"> 

   <div class="page-header mb-6 d-flex align-items-center position-relative" style="min-height: 120px;">
      
      <div class="header-left">
         <h1 class="page-title mb-0">실시간 모니터링</h1>
      </div>
      
      <div class="room-center" th:text="${targetRoom}">
         601
      </div>
      

   
   <div class="d-flex align-items-center ms-auto gap-3">
      
      <div class="sensor-widget" style="margin-bottom: 0 !important;">
         <div class="d-flex gap-2"> 
            <div style="width: 120px;"> 
               <div class="card sensor-card" style="background: linear-gradient(135deg, #f2d383 0%, #ed966b 100%); margin-bottom: 0;">
                  <div class="card-body text-center">
                     <div class="sensor-title">온도</div>
                     <div class="sensor-value" id="temperature">--</div>
                     <span class="sensor-unit">°C</span>
                  </div>
               </div>
            </div>
            
            <div style="width: 120px;">
               <div class="card sensor-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); margin-bottom: 0;">
                  <div class="card-body text-center">
                     <div class="sensor-title">습도</div>
                     <div class="sensor-value" id="humidity">--</div>
                     <span class="sensor-unit">%</span>
                  </div>
               </div>
            </div>
         </div>
      </div>
      
      <div class="grid-control btn-group">
         <button type="button" class="btn btn-outline-secondary" onclick="setGrid(2)">
            <i class="bi bi-grid me-1"></i>2x2
         </button>
         <button type="button" class="btn btn-primary" onclick="setGrid(3)">
            <i class="bi bi-grid-3x2 me-1"></i>3x2
         </button>
         <button type="button" class="btn btn-outline-secondary" onclick="setGrid(4)">
            <i class="bi bi-grid-fill me-1"></i>4x2
         </button>
      </div>

   </div>
</div>

            <!-- 카메라 그리드 -->
            <div id="cameraGrid" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">

   <div class="col" th:each="camera : ${cameras}"
        th:if="${camera.bedId != null and #strings.length(camera.bedId) >= 3 and #strings.substring(camera.bedId, 0, 3) == targetRoom}">
      <div class="card camera-card border-0">
         <div class="camera-view">
            <div class="camera-label">실시간 캠</div>
            <div class="status-badge status-normal" th:text="${camera.statusLabel}">정상</div>
            <img th:src="${camera.streamUrl}" style="width:100%; height:100%; object-fit:cover;">
         </div>
         <div class="patient-info text-center">
            <span class="bed-badge d-inline-block mb-1" th:text="${camera.bedId}"></span>
            <h6 class="patient-name mb-0" th:text="${camera.patientName}"></h6>
         </div>
      </div>
   </div>
         
            <!-- 2️⃣ cameras 없을 때만 patients -->
            <th:block th:if="${cameras == null or #lists.isEmpty(cameras)}">
               <div class="col" th:each="p : ${patients}"
                    th:if="${p.patientId != null and #strings.length(p.patientId) >= 3 and #strings.substring(p.patientId, 0, 3) == targetRoom}">
                  <div class="card camera-card border-0">
         
                     <div class="camera-view">
                     <div class="camera-label">실시간 캠</div>
                     <div class="status-badge status-normal">정상</div>
                  
                     <div class="camera-left"
                          th:data-folder="${#strings.substring(p.patientId, 0, 3)}"
                          th:data-sub="${p.patientId}"
                          th:data-pos="${p.position?.lastPosition}">
                  
                        <img class="patient-image dynamic-patient-img"
                             src="/images/bed_person.png"
                             alt="현재 체위">
                     </div>
                  
                     <div class="pose-arrow-center">
                        <i class="bi bi-arrow-right text-primary fw-bold fs-4"></i>
                     </div>
                  
                     <div class="camera-right">
                        <div class="pose-current">
                           <span class="pose-label">변경 예정</span>
                           <i class="bi bi-person-standing pose-icon"></i>
                           <span class="pose-value"
                                 th:with="cur=${p.position?.lastPosition}"
                                 th:text="${cur == '좌측위' ? '앙와위'
                                         : (cur == '앙와위' ? '우측위'
                                         : (cur == '우측위' ? '좌측위' : '확인'))}">
                           </span>
                        </div>
                     </div>
                  
                  </div>
                  
                  <div class="patient-info">
                     <div class="text-center mb-3">
  <span class="bed-badge d-inline-block mb-1"
        th:text="${p.patientId}"></span>
  <h6 class="patient-name mb-0"
      th:text="${p.name}"></h6>
</div>
                  
                     <div class="pose-display text-center">
                        <span class="pose-label">현재 체위</span>
                        <div class="pose-value"
                             th:text="${p.position != null ? p.position.lastPosition : '기록없음'}">
                        </div>
                     </div>
                  
                     <div class="timer-display">
                        <span class="timer-label">남은 시간</span>
                        <div class="timer-value timer-display"
                             th:data-start-time="${p.position?.lastPositionTime}">
                           00:00:00
                        </div>
                     </div>
                  </div>
                                    </div>
                                 </div>
                              </th:block>
                  
                        </div>
                     </div>
                  
                  </div>
         </main>
      </div>
   </div>

   <!-- Bootstrap Modal -->
   <div class="modal fade" id="alertModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
         <div class="modal-content border-danger border-3">
            <div class="modal-header bg-danger text-white">
               <h5 class="modal-title">
                  <i class="bi bi-exclamation-triangle-fill me-2"></i>자세 변경 알림
               </h5>
               <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center p-4">
               <p class="fs-5 mb-3">
                  <strong id="alertBed" class="text-danger"></strong> 환자분 자세 변경 시간입니다.
               </p>
               <div class="ratio ratio-16x9 mb-3">
                  <video id="guideVideo" muted loop class="rounded">
                     <source src="/videos/LtoS.mp4" type="video/mp4">
                  </video>
               </div>
               <button type="button" class="btn btn-success btn-lg w-100" data-bs-dismiss="modal">
                  <i class="bi bi-check-circle me-2"></i>확인 (조치 완료)
               </button>
            </div>
         </div>
      </div>
   </div>

   <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
   <script>
   let modalOpen = false;
   
      function setGrid(cols) {
         const grid = document.getElementById('cameraGrid');
         grid.className = 'row g-4';
         
         if (cols === 2) {
            grid.classList.add('row-cols-1', 'row-cols-md-2');
         } else if (cols === 3) {
            grid.classList.add('row-cols-1', 'row-cols-md-2', 'row-cols-lg-3');
         } else if (cols === 4) {
            grid.classList.add('row-cols-1', 'row-cols-md-2', 'row-cols-lg-4');
         }
      }

      // 타이머 업데이트 시뮬레이션
      const TOTAL_SECONDS = 2 * 60 * 60; // 2시간 = 7200초

function updateTimersFromDB() {
  const timers = document.querySelectorAll('.timer-value');

  timers.forEach(timer => {
    const startTimeStr = timer.dataset.startTime;
    if (!startTimeStr) return;

    // DB 시간 → Date 객체
    const startTime = new Date(startTimeStr);
    const now = new Date();

    // 경과 시간(초)
    const elapsedSeconds = Math.floor((now - startTime) / 1000);

    // 남은 시간
    let remaining = TOTAL_SECONDS - elapsedSeconds;
    if (remaining < 0) remaining = 0;

    const h = Math.floor(remaining / 3600);
    const m = Math.floor((remaining % 3600) / 60);
    const s = remaining % 60;

    timer.textContent =
      `${String(h).padStart(2,'0')}:` +
      `${String(m).padStart(2,'0')}:` +
      `${String(s).padStart(2,'0')}`;

    // 0초 → 알림
    if (remaining === 0 && !timer.dataset.alerted) {
      timer.dataset.alerted = "true";

      const card = timer.closest('.camera-card');
      const bedId = card.querySelector('.bed-badge').textContent;
      const patientName = card.querySelector('.patient-name').textContent;

      showAlert(`${bedId} (${patientName})`);
    }
  });
}

// 최초 실행 + 1초 주기
updateTimersFromDB();
setInterval(updateTimersFromDB, 1000);

function showAlert(bedInfo) {
     if (modalOpen) return;   // ✅ 중복 방지
     modalOpen = true;

     document.getElementById('alertBed').textContent = bedInfo;
     const modalEl = document.getElementById('alertModal');
     const modal = new bootstrap.Modal(modalEl);

     modal.show();

     const video = document.getElementById('guideVideo');
     video.currentTime = 0;
     video.play().catch(() => {});

     // ✅ 모달이 완전히 닫히면 backdrop 정리
     modalEl.addEventListener('hidden.bs.modal', () => {
       modalOpen = false;
       video.pause();

       document
         .querySelectorAll('.modal-backdrop')
         .forEach(b => b.remove());

       document.body.classList.remove('modal-open');
       document.body.style.removeProperty('padding-right');
     }, { once: true });
   }


      
      
      function loadLatestImages() {
          const cards = document.querySelectorAll('.camera-left');

          cards.forEach(card => {
             const folder = card.getAttribute('data-folder');
             const sub = card.getAttribute('data-sub');
             const pos = card.getAttribute('data-pos');
             const imgTag = card.querySelector('.dynamic-patient-img');

             let prefix = "default";
             if (pos === '앙와위') prefix = "face";
             else if (pos === '좌측위') prefix = "left";
             else if (pos === '우측위') prefix = "right";

             checkImageExists(imgTag, folder, sub, prefix, 10);
          });
       }

       function checkImageExists(imgTag, folder, sub, prefix, num) {
          if (num <= 0) return;

          const path = `/images/${folder}/${sub}/${prefix}${num}.jpg`;
          const img = new Image();

          img.onload = () => imgTag.src = path;
          img.onerror = () => checkImageExists(imgTag, folder, sub, prefix, num - 1);
          img.src = path;
       }

       document.addEventListener("DOMContentLoaded", loadLatestImages);
   </script>
</body>
</html>