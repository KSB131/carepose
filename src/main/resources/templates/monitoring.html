<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">
<head>
    <title>실시간 모니터링</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body class="monitoring-mode">
   
   
   
    <div layout:fragment="content">
        
        <!-- 페이지 헤더 -->
        <div class="page-header">
            <div>
                <h2 class="page-title">실시간 모니터링</h2>
                <p class="page-description">카메라 영상 및 스켈레톤 좌표</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-small" onclick="setGridSize(2)">2x2</button>
                <button class="btn btn-primary" style="width:auto; padding:0 16px;" onclick="setGridSize(3)">3x2</button>
                <button class="btn btn-small" onclick="setGridSize(4)">4x2</button>
            </div>
        </div>

        <!-- 카메라 그리드 -->
        <div id="cameraGrid" class="camera-grid">
            
            <!-- th:each로 카메라 목록 반복 -->
            <div th:each="camera : ${cameras}" 
                 th:classappend="${camera.status == 'WARNING'} ? 'camera-card-warning' : (${camera.status == 'DANGER'} ? 'camera-card-danger' : '')"
                 class="camera-card">
                <div class="camera-view">
                    <!-- 실제 개발 시: 스트리밍 영상 -->
                    <img th:src="${camera.streamUrl}" alt="카메라 영상" style="width:100%; height:100%; object-fit:cover;">
                    <div th:classappend="${camera.status == 'NORMAL'} ? 'camera-status-normal' : (${camera.status == 'WARNING'} ? 'camera-status-warning' : 'camera-status-danger')"
                         class="camera-status-badge"
                         th:text="${camera.statusLabel}">상태</div>
                </div>
                <div class="camera-info">
                    <div>
                        <span class="bed-id" th:text="${camera.bedId}">ID</span>
                        <span class="patient-name" th:text="${camera.patientName}">환자명</span>
                    </div>
                    <span class="current-pose" th:text="'현재: ' + ${camera.currentPose}">자세</span>
                </div>
            </div>

            <!-- 샘플 데이터 -->
            <th:block th:if="${cameras == null or #lists.isEmpty(cameras)}">
                <div th:each="p : ${patients}" class="camera-card">
                
                    <div class="camera-view">
                    <div class="left-side">
                        <span class="side-label">현재 체위</span>
                        <h1 th:if="${p.position != null}" class="pose-text" th:text="${p.position.lastPosition}">좌측위</h1>
                        <h1 th:unless="${p.position != null}" class="no-data">없음</h1>
                    </div>
                    
                    <div class="center-arrow">
                       <i class="arrow-icon">➔</i>
                   </div>
            
                    <div class="right-side">
                        <span class="side-label">변경 예정</span>
                        <h1 th:if="${p.position != null}" class="pose-text"
                            th:with="pos=${p.position.lastPosition}"
                            th:text="${pos == '좌측위' ? '앙와위' : (pos == '앙와위' ? '우측위' : (pos == '우측위' ? '좌측위' : '확인'))}">
                            정상위
                        </h1>
                        <h1 th:unless="${p.position != null}" class="no-data">-</h1>
                    </div>
            
                    <div class="camera-status-badge camera-status-normal">정상</div>
                </div>
                    
                    <div class="camera-info">
                   <div>
                       <span class="bed-id" th:text="${p.patientId}">101-A</span>
                       <span class="patient-name" th:text="${p.name}">김○○</span>
                   </div>
                   
                   <div th:if="${p.position != null}">
                       <span class="current-time" style="font-size: 0.85rem; color: #555;">상태 기록 후: </span>
                       <strong class="timer-display" 
                             style="color: #d9534f;" 
                             th:if="${p.position != null}"
                             th:data-start-time="${p.position.lastPositionTime}">
                         계산 중...
                     </strong>
                       <br>
                       <small style="color: #888;" 
                              th:text="'(' + ${#temporals.format(p.position.lastPositionTime, 'yyyy/MM/dd HH:mm')} + ' 기록)'">
                           (10:23 기록)
                       </small>
                   </div>
                   <div th:unless="${p.position != null}">
                       <small style="color: #ccc;">기록 없음</small>
                   </div>
               </div>
               
                </div>
                
            </th:block>
        </div>

    </div>

    <script>
        // 그리드 크기 변경
        function setGridSize(cols) {
            var grid = document.getElementById('cameraGrid');
            grid.style.gridTemplateColumns = 'repeat(' + cols + ', 1fr)';
        }
        
        // 실시간 타이머
        function updateTimers() {
            const timerElements = document.querySelectorAll('.timer-display');
            
            timerElements.forEach(el => {
                const startTimeStr = el.getAttribute('data-start-time'); // 서버에서 온 시간 (ISO 포맷)
                if (!startTimeStr) return;

                const startTime = new Date(startTimeStr);
                const now = new Date();
                
                // 시간 차이 계산 (밀리초 -> 초)
                const diffInSeconds = Math.floor((now - startTime) / 1000);

                if (diffInSeconds < 0) {
                    el.innerText = "0분 0초";
                    return;
                }

                const minutes = Math.floor(diffInSeconds / 60);
                const seconds = diffInSeconds % 60;

                // 원하는 포맷으로 표시 (예: 100분 10초)
                el.innerText = `${minutes}분 ${seconds}초`;
                
                // 만약 100:10 포맷을 원하시면 아래 코드를 사용하세요
                // el.innerText = `${minutes}:${seconds < 10 ? '0' + seconds : seconds}`;
            });
        }

        // 페이지 로드 시 즉시 실행 후, 1초마다 반복
        updateTimers();
        setInterval(updateTimers, 1000);

        // 기존 그리드 크기 변경 함수
        function setGridSize(cols) {
            var grid = document.getElementById('cameraGrid');
            grid.style.gridTemplateColumns = 'repeat(' + cols + ', 1fr)';
        }
    </script>

</body>
</html>
