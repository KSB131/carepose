<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì¹¨ìƒ ê´€ë¦¬</title>
<!-- Bootstrap 5 CSS -->
<link
   href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
   rel="stylesheet">
<link rel="stylesheet"
   href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link rel="stylesheet" th:href="@{/css/style.css}">

</head>

<body class="bg-light">

   <div class="container-fluid">
      <div class="row">
         <!-- Sidebar -->
         <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse p-0">
            <div class="position-sticky pt-4 px-3">
               <div class="mb-4">
                  <h5 class="fw-bold text-white">
                     SMHRD ìš”ì–‘ë³‘ì›<br>ì•ˆì „ ê´€ì œì‹œìŠ¤í…œ
                  </h5>
               </div>

               <ul class="nav flex-column">
                  <li class="nav-item"><a class="nav-link"
                     th:href="@{/dashboard}"
                     th:classappend="${requestURI.contains('/dashboard')} ? 'active'">
                        <i class="bi bi-speedometer2 me-2"></i>ëŒ€ì‹œë³´ë“œ
                  </a></li>
                  <li class="nav-item"><a class="nav-link"
                     th:href="@{/patients}"
                     th:classappend="${requestURI.contains('/patients')} ? 'active'">
                        <i class="bi bi-hospital me-2"></i>ë³‘ì‹¤ í˜„í™©
                  </a></li>
                  <li class="nav-item"><a class="nav-link" th:href="@{/rooms}"
                     th:classappend="${requestURI.contains('/rooms')} ? 'active'">
                        <i class="bi bi-camera-video me-2"></i>ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§
                  </a></li>
                  <li class="nav-item"><a class="nav-link"
                     th:classappend="${requestURI.contains('/alerts')} ? 'active'">
                        <i class="bi bi-bell me-2"></i>ì•Œë¦¼ ì„¼í„°
                  </a></li>
               </ul>

               <div class="mt-5 px-3">
                  <span class="small text-muted" style="color: silver !important;">carepose
                     1.0.0</span>
               </div>
            </div>
         </nav>

         <!-- Main Content -->
         <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">

            <div class="page-header d-flex align-items-center">
               <div>
                  <h1 class="page-title mb-1">ì¹¨ìƒ ê´€ë¦¬</h1>
                  <p class="text-muted mb-0">ë””ë°”ì´ìŠ¤-í™˜ì ë§¤í•‘ ê´€ë¦¬</p>
               </div>
               <div class="ms-auto">
                  <button type="button" class="btn btn-info" data-bs-toggle="modal"
                     data-bs-target="#patientModal">+ ì‹ ê·œ í™˜ì ë“±ë¡</button>
               </div>
            </div>


            <!-- Search & Filter -->
            <div class="card shadow-sm mb-4">
               <div class="card-body">
                  <form th:action="@{/patients}" method="get"
                     class="row g-3 align-items-center">
                     <div class="col-md-9">
                        <input type="text" name="keyword"
                           class="form-control form-control-lg "
                           placeholder="ğŸ” í™˜ì ì„±ëª… ë˜ëŠ” ë³‘ì‹¤ ê²€ìƒ‰..." th:value="${keyword}">
                     </div>

                     <div class="col-md-3">
                        <button type="submit" class="btn btn-primary w-100">ê²€ìƒ‰</button>
                     </div>
                  </form>
               </div>
            </div>

            <!-- Patients Table -->
            <div class="card shadow-sm">
               <div class="card-body p-0">
                  <div class="table-responsive">
                     <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                           <tr>
                              <th>ì¹¨ìƒ ID</th>
                              <th>í™˜ìëª…</th>
                              <th>ìš•ì°½ ë‹¨ê³„</th>
                              <th>ìš•ì°½ ë¶€ìœ„</th>
                              <th>ê°œì¸ë³„ ì‹¤ì‹œê°„ í™”ë©´</th>
                              <th>ê´€ë¦¬</th>
                           </tr>
                        </thead>
                        <tbody>
                           <tr th:each="patient : ${patients}">
                              <td class="fw-bold" th:text="${patient.roomBed}">101-A</td>
                              <td th:text="${patient.name}">í™˜ìëª…</td>
                              <td><span th:switch="${patient.grade}"> <span
                                    th:case="0" class="badge bg-secondary">ì—†ìŒ</span> <span
                                    th:case="1" class="badge bg-success">1ë‹¨ê³„</span> <span
                                    th:case="2" class="badge bg-warning text-dark">2ë‹¨ê³„</span> <span
                                    th:case="3" class="badge bg-danger">3ë‹¨ê³„</span> <span
                                    th:case="4" class="badge bg-danger">4ë‹¨ê³„</span> <span
                                    th:case="*" class="badge bg-secondary">ë¯¸ì…ë ¥</span>
                              </span></td>
                              <td th:text="${patient.ulcerLocation ?: '-'}">ë¶€ìœ„</td>
                              <td>
                                 <button class="btn btn-sm btn-outline-success me-1"
                                    th:attr="data-id=${patient.patientId}"
                                    onclick="openCameraPopup()">í™”ë©´ ë³´ëŸ¬ê°€ê¸°</button>
                              </td>
                              <td>
                                 <button class="btn btn-sm btn-outline-primary me-1"
                                    th:attr="data-id=${patient.patientId}"
                                    onclick="editPatient(this)">ìˆ˜ì •</button>
                                 <button class="btn btn-sm btn-outline-danger"
                                    th:attr="data-id=${patient.patientId}"
                                    onclick="deletePatient(this)">ì‚­ì œ</button>
                              </td>
                           </tr>

                           <!-- Empty State / Sample (Optional: Only show if list empty) -->
                           <tr th:if="${#lists.isEmpty(patients)}">
                              <td colspan="6" class="text-center py-4 text-muted">ë“±ë¡ëœ
                                 í™˜ìê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                           </tr>
                        </tbody>
                     </table>
                  </div>
               </div>
            </div>

            <!-- Pagination -->
            <nav aria-label="Page navigation" class="mt-4"
               th:if="${totalPages > 1}">
               <ul class="pagination justify-content-center">
                  <li class="page-item"
                     th:classappend="${currentPage == 0} ? 'disabled'"><a
                     class="page-link" th:href="@{/patients(page=${currentPage - 1})}"
                     tabindex="-1">ì´ì „</a></li>
                  <li class="page-item"
                     th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                     th:classappend="${i == currentPage} ? 'active'"><a
                     class="page-link" th:href="@{/patients(page=${i})}"
                     th:text="${i + 1}">1</a></li>
                  <li class="page-item"
                     th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
                     <a class="page-link"
                     th:href="@{/patients(page=${currentPage + 1})}">ë‹¤ìŒ</a>
                  </li>
               </ul>
            </nav>

         </main>
      </div>
   </div>

   <!-- Bootstrap Modal -->
   <div class="modal fade" id="patientModal" tabindex="-1"
      aria-labelledby="patientModalLabel" aria-hidden="true">
      <div class="modal-dialog">
         <div class="modal-content">
            <div class="modal-header">
               <h5 class="modal-title" id="patientModalLabel">ì‹ ê·œ í™˜ì ë“±ë¡</h5>
               <button type="button" class="btn-close" data-bs-dismiss="modal"
                  aria-label="Close"></button>
            </div>
            <form th:action="@{/patients}" method="post">
               <div class="modal-body">
                  <div class="mb-3">
                     <label class="form-label">ì¹¨ìƒ ID *</label> <input type="text"
                        name="roomBed" class="form-control" required>
                  </div>
                  <div class="mb-3">
                     <label class="form-label">í™˜ìëª… *</label> <input type="text"
                        name="name" class="form-control" required>
                  </div>
                  <div class="mb-3">
                     <label class="form-label">ìš•ì°½ ë‹¨ê³„</label> <select name="grade"
                        class="form-select">
                        <option value="0">ì—†ìŒ</option>
                        <option value="1">1ë‹¨ê³„</option>
                        <option value="2">2ë‹¨ê³„</option>
                        <option value="3">3ë‹¨ê³„</option>
                        <option value="4">4ë‹¨ê³„</option>
                     </select>
                  </div>
                  <div class="mb-3">
                     <label class="form-label">ìš•ì°½ ë¶€ìœ„</label> <input type="text"
                        name="ulcerLocation" class="form-control"
                        placeholder="ì²œê³¨, ë°œê¿ˆì¹˜ ë“±">
                  </div>
               </div>
               <div class="modal-footer">
                  <button type="submit" class="btn btn-primary">ë“±ë¡</button>
                  <button type="button" class="btn btn-secondary"
                     data-bs-dismiss="modal">ì·¨ì†Œ</button>
               </div>
            </form>
         </div>
      </div>
   </div>

   <!-- Bootstrap 5 JS Bundle -->
   <script
      src="https://192.168.219.208:8000/video_feed"></script>

   <script>
    function editPatient(btn) {
         const id = btn.getAttribute("data-id");
         location.href = "/patients/" + id;
      }

      function deletePatient(btn) {
         if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            const id = btn.getAttribute("data-id");
            location.href = "/patients/delete/" + id;
         }
      }
      
      function openCameraPopup() {
           const width = 1024;
           const height = 768;
           const left = (screen.width - width) / 2;
           const top = (screen.height - height) / 2;
           
           const popup = window.open(
               '',
               'Pose_Classification_Stream',
               `width=${width},height=${height},left=${left},top=${top},resizable=yes`
           );
           
           popup.document.write(`
               <!DOCTYPE html>
               <html>
               <head>
                   <meta charset="UTF-8">
                   <title>ì‹¤ì‹œê°„ ìì„¸ ë¶„ë¥˜ ëª¨ë‹ˆí„°ë§</title>
                   <style>
                       * {
                           margin: 0;
                           padding: 0;
                           box-sizing: border-box;
                       }
                       body {
                           background: #1a1a1a;
                           display: flex;
                           flex-direction: column;
                           height: 100vh;
                           font-family: 'Segoe UI', Arial, sans-serif;
                       }
                       .header {
                           background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                           color: white;
                           padding: 20px 30px;
                           box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                       }
                       .header h1 {
                           font-size: 24px;
                           margin: 0 0 5px 0;
                       }
                       .header p {
                           font-size: 14px;
                           opacity: 0.9;
                           margin: 0;
                       }
                       .status-bar {
                           background: #2a2a2a;
                           padding: 10px 30px;
                           display: flex;
                           justify-content: space-between;
                           align-items: center;
                           border-bottom: 2px solid #667eea;
                       }
                       .status-item {
                           display: flex;
                           align-items: center;
                           gap: 10px;
                           color: white;
                           font-size: 14px;
                       }
                       .status-dot {
                           width: 10px;
                           height: 10px;
                           background: #4CAF50;
                           border-radius: 50%;
                           animation: pulse 2s infinite;
                       }
                       @keyframes pulse {
                           0%, 100% { opacity: 1; transform: scale(1); }
                           50% { opacity: 0.5; transform: scale(1.1); }
                       }
                       .video-container {
                           flex: 1;
                           display: flex;
                           justify-content: center;
                           align-items: center;
                           padding: 20px;
                           background: #000;
                       }
                       #videoStream {
                           max-width: 100%;
                           max-height: 100%;
                           border-radius: 10px;
                           box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
                       }
                       .info-panel {
                           background: #2a2a2a;
                           color: white;
                           padding: 15px 30px;
                           display: flex;
                           gap: 30px;
                           flex-wrap: wrap;
                       }
                       .info-item {
                           display: flex;
                           flex-direction: column;
                       }
                       .info-label {
                           font-size: 12px;
                           color: #999;
                           margin-bottom: 5px;
                       }
                       .info-value {
                           font-size: 18px;
                           font-weight: bold;
                           color: #4CAF50;
                       }
                       .controls {
                           background: #1a1a1a;
                           padding: 20px;
                           display: flex;
                           justify-content: center;
                           gap: 15px;
                       }
                       button {
                           padding: 12px 30px;
                           border: none;
                           border-radius: 8px;
                           cursor: pointer;
                           font-size: 15px;
                           font-weight: bold;
                           transition: all 0.3s;
                       }
                       .btn-close {
                           background: #f44336;
                           color: white;
                       }
                       .btn-close:hover {
                           background: #d32f2f;
                           transform: translateY(-2px);
                           box-shadow: 0 5px 15px rgba(244, 67, 54, 0.4);
                       }
                   </style>
               </head>
               <body>
                   <div class="header">
                       <h1>ğŸ¥ ì‹¤ì‹œê°„ ìì„¸ ë¶„ë¥˜ ëª¨ë‹ˆí„°ë§</h1>
                       <p>YOLO11n-Pose + Custom Classification Model</p>
                   </div>
                   
                   <div class="status-bar">
                       <div class="status-item">
                           <div class="status-dot"></div>
                           <span>ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° í™œì„±í™”</span>
                       </div>
                       <div class="status-item">
                           <span>ë¶„ë¥˜: supine / left / right</span>
                       </div>
                   </div>
                   
                   <div class="video-container">
                       <img id="videoStream" src="http://localhost:8000/video_feed" alt="Loading...">
                   </div>
                   
                   <div class="info-panel">
                       <div class="info-item">
                           <div class="info-label">ëª¨ë¸ ìƒíƒœ</div>
                           <div class="info-value">âœ“ ì •ìƒ</div>
                       </div>
                       <div class="info-item">
                           <div class="info-label">FPS</div>
                           <div class="info-value">~30</div>
                       </div>
                       <div class="info-item">
                           <div class="info-label">í•´ìƒë„</div>
                           <div class="info-value">640x480</div>
                       </div>
                   </div>
                   
                   <div class="controls">
                       <button class="btn-close" onclick="window.close()">
                           âŒ ì°½ ë‹«ê¸°
                       </button>
                   </div>
                   
                   <script>
                       const img = document.getElementById('videoStream');
                       
                       img.onerror = function() {
                           alert('ì¹´ë©”ë¼ ì—°ê²° ì‹¤íŒ¨! FastAPI ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.\\n\\nì„œë²„ ì£¼ì†Œ: http://localhost:8000');
                       };
                       
                       img.onload = function() {
                           console.log('âœ“ ìŠ¤íŠ¸ë¦¬ë° ì—°ê²° ì„±ê³µ');
                       };
                   <\/script>
               </body>
               </html>
           `);
       }
    </script>

</body>
</html>